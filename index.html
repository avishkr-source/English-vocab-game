<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>WordUp â€“ ×œ×™××•×“ ×× ×’×œ×™×ª</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6c63ff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WordUp">

<!-- Icon (SVG inline as data URI) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%236c63ff'/%3E%3Ctext x='50' y='62' font-size='54' text-anchor='middle' font-family='Arial' font-weight='bold' fill='white'%3EW%3C/text%3E%3Ccircle cx='72' cy='28' r='14' fill='%23ff6584'/%3E%3Ctext x='72' y='34' font-size='16' text-anchor='middle' font-family='Arial' font-weight='bold' fill='white'%3EğŸš€%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f4f0;
    --card: #ffffff;
    --primary: #6c63ff;
    --primary-light: #ede9ff;
    --accent: #ff6584;
    --accent-light: #fff0f3;
    --green: #43c59e;
    --green-light: #e6faf5;
    --yellow: #ffc947;
    --yellow-light: #fff8e6;
    --text: #1a1a2e;
    --text-muted: #8888aa;
    --border: #e8e8f0;
    --shadow: 0 4px 24px rgba(108,99,255,0.10);
    --radius: 18px;
    --radius-sm: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    overflow-x: hidden;
    width: 100%;
  }

  body {
    font-family: 'Rubik', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    direction: rtl;
  }

  /* â”€â”€â”€ NAV â”€â”€â”€ */
  nav {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky;
    top: 0;
    z-index: 100;
    width: 100%;
    max-width: 100vw;
    overflow: hidden;
  }
  .logo {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 20px;
    color: var(--primary);
    letter-spacing: -0.5px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .logo span { color: var(--accent); }
  .nav-score {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    flex-shrink: 0;
    overflow: hidden;
  }
  .score-pill {
    background: var(--primary-light);
    color: var(--primary);
    padding: 5px 10px;
    border-radius: 99px;
    font-weight: 700;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }
  .streak-pill {
    background: var(--yellow-light);
    color: #d97706;
    padding: 5px 10px;
    border-radius: 99px;
    font-weight: 700;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  /* â”€â”€â”€ TABS â”€â”€â”€ */
  .tabs {
    display: flex;
    gap: 4px;
    padding: 12px 12px 0;
    border-bottom: 1px solid var(--border);
    background: var(--card);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    max-width: 100vw;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 10px 18px;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    border: none;
    background: none;
    font-family: 'Rubik', sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    border-bottom: 2px solid transparent;
  }
  .tab:hover { color: var(--primary); }
  .tab.active {
    color: var(--primary);
    font-weight: 700;
    border-bottom: 2px solid var(--primary);
  }

  /* â”€â”€â”€ SCREENS â”€â”€â”€ */
  .screen { display: none; padding: 16px 16px 32px; width: 100%; max-width: 600px; margin: 0 auto; }
  .screen.active { display: block; }
  #screen-run.screen.active { display: flex; }

  /* â”€â”€â”€ HOME SCREEN â”€â”€â”€ */
  .hero {
    text-align: center;
    padding: 20px 0 16px;
  }
  .hero h1 {
    font-family: 'Nunito', sans-serif;
    font-size: 26px;
    font-weight: 900;
    line-height: 1.2;
    margin-bottom: 6px;
  }
  .hero p { color: var(--text-muted); font-size: 14px; }
  
  /* â”€â”€â”€ HOME CONTROLS ROW â”€â”€â”€ */
  .home-controls {
    display: flex;
    gap: 8px;
    margin: 12px 0 16px;
    align-items: stretch;
  }
  .home-controls .ctrl-btn {
    flex: 1;
    padding: 11px 8px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    cursor: pointer;
    font-family: 'Rubik', sans-serif;
    font-weight: 600;
    font-size: 13px;
    text-align: center;
    transition: all 0.2s;
    color: var(--text);
    position: relative;
    white-space: nowrap;
  }
  .home-controls .ctrl-btn:hover { border-color: var(--primary); color: var(--primary); }
  .home-controls .ctrl-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
  .home-controls .ctrl-btn.packs-btn { flex: 0 0 auto; padding: 11px 12px; }

  /* â”€â”€â”€ DROPDOWN PANEL â”€â”€â”€ */
  .dropdown-panel {
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    z-index: 150;
    min-width: 180px;
    overflow: hidden;
    display: none;
  }
  .dropdown-panel.open { display: block; animation: pop 0.15s ease; }
  .dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .dropdown-item:hover { background: var(--bg); }
  .dropdown-item.selected { color: var(--primary); }
  .dropdown-item .chk {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; flex-shrink: 0;
    transition: all 0.15s;
  }
  .dropdown-item.checked .chk { background: var(--primary); border-color: var(--primary); color: white; }
  .dropdown-divider { border: none; border-top: 1px solid var(--border); margin: 4px 0; }

  .level-selector { display: none; } /* hide old */

  .game-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin: 12px 0;
  }
  .game-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 16px 12px;
    cursor: pointer;
    border: 2px solid var(--border);
    transition: all 0.2s;
    text-align: center;
  }
  .game-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }
  .game-card .game-icon { font-size: 32px; margin-bottom: 8px; }
  .game-card .game-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
  .game-card .game-desc { color: var(--text-muted); font-size: 12px; }
  .game-card .game-score {
    margin-top: 10px;
    font-size: 12px;
    color: var(--primary);
    font-weight: 600;
  }

  /* â”€â”€â”€ MULTIPLE CHOICE GAME â”€â”€â”€ */
  .game-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .btn-back {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    padding: 4px;
    border-radius: 8px;
    transition: background 0.2s;
  }
  .btn-back:hover { background: var(--border); }
  .game-title { font-weight: 700; font-size: 17px; }
  .game-progress {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 600;
  }

  .progress-bar-wrap {
    background: var(--border);
    border-radius: 99px;
    height: 8px;
    margin-bottom: 28px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    border-radius: 99px;
    transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
  }

  .word-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 36px 24px;
    text-align: center;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .word-label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }
  .word-main {
    font-family: 'Nunito', sans-serif;
    font-size: 38px;
    font-weight: 900;
    color: var(--primary);
    margin-bottom: 6px;
    line-height: 1.1;
  }
  .word-example {
    color: var(--text-muted);
    font-size: 14px;
    font-style: italic;
    margin-top: 8px;
  }

  .options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .option-btn {
    padding: 16px 12px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    cursor: pointer;
    font-family: 'Rubik', sans-serif;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    transition: all 0.15s;
    color: var(--text);
  }
  .option-btn:hover:not(:disabled) {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }
  .option-btn.correct {
    border-color: var(--green);
    background: var(--green-light);
    color: #0d6e50;
  }
  .option-btn.wrong {
    border-color: var(--accent);
    background: var(--accent-light);
    color: #c0002e;
  }
  .option-btn:disabled { cursor: default; }

  .feedback-banner {
    margin-top: 18px;
    padding: 14px 20px;
    border-radius: var(--radius-sm);
    text-align: center;
    font-weight: 700;
    font-size: 16px;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .feedback-banner.correct { background: var(--green-light); color: #0d6e50; display: flex; }
  .feedback-banner.wrong { background: var(--accent-light); color: #c0002e; display: flex; }

  .next-btn {
    width: 100%;
    margin-top: 16px;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif;
    font-size: 17px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    display: none;
  }
  .next-btn:hover { background: #5a52e0; transform: translateY(-1px); }
  .next-btn.visible { display: block; }

  /* â”€â”€â”€ FLASHCARD GAME â”€â”€â”€ */
  .flashcard-wrap {
    perspective: 1000px;
    margin: 20px 0;
    cursor: pointer;
  }
  .flashcard {
    width: 100%;
    height: 220px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s cubic-bezier(0.4,0,0.2,1);
    border-radius: var(--radius);
  }
  .flashcard.flipped { transform: rotateY(180deg); }
  .card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    text-align: center;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .card-front { background: var(--card); }
  .card-back {
    background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
    color: white;
    transform: rotateY(180deg);
  }
  .card-face .word { font-family: 'Nunito', sans-serif; font-size: 40px; font-weight: 900; margin-bottom: 8px; }
  .card-face .hint { font-size: 13px; opacity: 0.6; }
  .card-back .word { color: white; }
  .card-back .example { font-size: 14px; opacity: 0.85; margin-top: 8px; font-style: italic; }

  .flash-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 16px;
  }
  .flash-btn {
    padding: 16px;
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    display: none;
  }
  .flash-btn.visible { display: block; }
  .flash-btn.knew { background: var(--green-light); color: #0d6e50; }
  .flash-btn.knew:hover { background: var(--green); color: white; }
  .flash-btn.didnt { background: var(--accent-light); color: #c0002e; }
  .flash-btn.didnt:hover { background: var(--accent); color: white; }

  /* â”€â”€â”€ RESULTS â”€â”€â”€ */
  .results {
    text-align: center;
    padding: 40px 20px;
  }
  .results-icon { font-size: 64px; margin-bottom: 16px; }
  .results h2 {
    font-family: 'Nunito', sans-serif;
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 8px;
  }
  .results p { color: var(--text-muted); margin-bottom: 28px; }
  .results-stats {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 28px;
  }
  .stat-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px 12px;
  }
  .stat-box .stat-val {
    font-family: 'Nunito', sans-serif;
    font-size: 28px;
    font-weight: 900;
    color: var(--primary);
  }
  .stat-box .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .btn-primary {
    width: 100%;
    padding: 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif;
    font-size: 17px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 10px;
  }
  .btn-primary:hover { background: #5a52e0; }
  .btn-secondary {
    width: 100%;
    padding: 14px;
    background: none;
    color: var(--text-muted);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }

  /* â”€â”€â”€ LEADERBOARD / STATS â”€â”€â”€ */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 24px;
  }
  .big-stat {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 16px;
    text-align: center;
  }
  .big-stat .val {
    font-family: 'Nunito', sans-serif;
    font-size: 36px;
    font-weight: 900;
    color: var(--primary);
  }
  .big-stat .lbl { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-top: 2px; }
  .history-list { display: flex; flex-direction: column; gap: 10px; }
  .history-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .history-item .hi-left { display: flex; align-items: center; gap: 10px; }
  .history-item .hi-icon { font-size: 22px; }
  .history-item .hi-name { font-weight: 700; font-size: 14px; }
  .history-item .hi-date { font-size: 12px; color: var(--text-muted); }
  .history-item .hi-score { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 20px; color: var(--primary); }

  /* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
  @keyframes pop { 0%{transform:scale(0.8);opacity:0} 70%{transform:scale(1.05)} 100%{transform:scale(1);opacity:1} }
  @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
  .pop { animation: pop 0.3s ease forwards; }
  .shake { animation: shake 0.35s ease; }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
  .empty-state .e-icon { font-size: 48px; margin-bottom: 12px; }

  /* â”€â”€â”€ FILL IN THE BLANK â”€â”€â”€ */
  .sentence-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 32px 24px;
    text-align: center;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .sentence-text {
    font-size: 20px;
    font-weight: 600;
    line-height: 1.6;
    direction: ltr;
    text-align: center;
    color: var(--text);
  }
  .sentence-blank {
    display: inline-block;
    background: var(--primary-light);
    color: var(--primary);
    border-radius: 8px;
    padding: 2px 14px;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    letter-spacing: 2px;
    min-width: 80px;
    vertical-align: middle;
  }
  .sentence-blank.revealed {
    background: var(--green-light);
    color: #0d6e50;
    letter-spacing: 0;
  }
  .translation-flash {
    margin-top: 14px;
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 600;
    min-height: 22px;
    transition: opacity 0.3s;
  }
  .translation-flash.show {
    color: var(--primary);
    font-size: 16px;
  }

  .pack-item-edit { background: none; border: none; font-size: 16px; cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.15s; }
  .pack-item-edit:hover { opacity: 1; }
  .edit-pack-header {
    display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
  }
  .edit-pack-header h3 { flex: 1; font-weight: 800; font-size: 16px; margin: 0; }
  /* â”€â”€â”€ CUSTOM PACKS â”€â”€â”€ */
  .custom-banner {
    background: linear-gradient(135deg, var(--primary-light), #f0eeff);
    border: 2px solid var(--primary);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin-bottom: 16px;
    display: none;
  }
  .custom-banner.visible { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
  .custom-banner-text { font-size: 13px; font-weight: 700; color: var(--primary); flex: 1; }
  .custom-banner-clear { background: none; border: none; color: var(--accent); font-size: 18px; cursor: pointer; padding: 2px; }

  .pack-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
  .pack-item {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .pack-item.selected { border-color: var(--primary); background: var(--primary-light); }
  .pack-item-check {
    width: 22px; height: 22px;
    border: 2px solid var(--border);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; flex-shrink: 0;
    transition: all 0.15s;
  }
  .pack-item.selected .pack-item-check { background: var(--primary); border-color: var(--primary); color: white; }
  .pack-item-info { flex: 1; }
  .pack-item-name { font-weight: 700; font-size: 15px; }
  .pack-item-count { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .pack-item-delete { background: none; border: none; font-size: 18px; cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.15s; }
  .pack-item-delete:hover { opacity: 1; }

  .mix-toggle {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 12px;
  }
  .mix-toggle-text { font-size: 14px; font-weight: 600; }
  .mix-toggle-text small { display: block; font-size: 12px; color: var(--text-muted); font-weight: 400; margin-top: 2px; }
  .toggle-switch {
    width: 48px; height: 26px;
    background: var(--border);
    border-radius: 99px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
    border: none;
  }
  .toggle-switch.on { background: var(--primary); }
  .toggle-switch::after {
    content: '';
    position: absolute;
    width: 20px; height: 20px;
    background: white;
    border-radius: 99px;
    top: 3px; right: 3px;
    transition: transform 0.2s;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .toggle-switch.on::after { transform: translateX(-22px); }

  /* new pack form */
  .new-pack-form {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 16px;
    margin-top: 16px;
  }
  .new-pack-form h3 { font-weight: 800; font-size: 16px; margin-bottom: 14px; }
  .pack-name-input, .pack-words-textarea {
    width: 100%;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: 'Rubik', sans-serif;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
    padding: 12px 14px;
    margin-bottom: 12px;
    display: block;
  }
  .pack-name-input:focus, .pack-words-textarea:focus { border-color: var(--primary); }
  .pack-words-textarea {
    min-height: 140px;
    resize: vertical;
    direction: ltr;
    font-size: 14px;
    line-height: 1.6;
  }
  .pack-hint { font-size: 12px; color: var(--text-muted); margin-bottom: 14px; line-height: 1.5; }
  .translate-status {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    padding: 10px;
    display: none;
  }
  .translate-status.visible { display: block; }
  /* preview table */
  .preview-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; }
  .preview-table th { background: var(--bg); padding: 8px 10px; text-align: right; font-weight: 700; font-size: 12px; color: var(--text-muted); }
  .preview-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  .preview-table td input {
    border: none; background: none; width: 100%;
    font-family: 'Rubik', sans-serif; font-size: 14px;
    color: var(--text); outline: none;
  }
  .preview-table td:first-child { direction: ltr; }
  .preview-table td:last-child { direction: rtl; }
  .match-config {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin-bottom: 16px;
  }
  .match-config label { font-weight: 700; font-size: 14px; }
  .match-count-btns { display: flex; gap: 6px; }
  .match-count-btn {
    width: 36px; height: 36px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: none;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-muted);
  }
  .match-count-btn.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }

  .match-timer-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    gap: 12px;
  }
  .match-timer {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    color: var(--primary);
    min-width: 52px;
    text-align: center;
  }
  .match-timer.warning { color: var(--accent); }
  .match-pairs-left {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 600;
    white-space: nowrap;
  }

  .match-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .match-col { display: flex; flex-direction: column; gap: 8px; }

  .match-word {
    padding: 14px 10px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    font-weight: 700;
    font-size: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
    min-height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
  }
  .match-word:hover:not(.matched):not(.wrong-flash) {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }
  .match-word.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
    transform: scale(1.03);
    box-shadow: var(--shadow);
  }
  .match-word.matched {
    border-color: var(--green);
    background: var(--green-light);
    color: #0d6e50;
    cursor: default;
    opacity: 0.7;
  }
  .match-word.wrong-flash {
    border-color: var(--accent);
    background: var(--accent-light);
    color: #c0002e;
    animation: shake 0.35s ease;
  }
  .match-word[data-lang="en"] { direction: ltr; }
  .match-word[data-lang="he"] { direction: rtl; }
  .dir-toggle {
    display: flex;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 3px;
    gap: 2px;
    margin-bottom: 20px;
  }
  .dir-btn {
    flex: 1;
    padding: 8px 14px;
    border: none;
    border-radius: 99px;
    background: none;
    font-family: 'Rubik', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .dir-btn.active {
    background: var(--card);
    color: var(--primary);
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  }

  .words-remaining {
    text-align: center;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 12px;
  }

  /* â”€â”€â”€ NICKNAME MODAL â”€â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,26,46,0.7);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .modal-overlay.hidden { display: none; }
  .modal-box {
    background: var(--card);
    border-radius: var(--radius);
    padding: 40px 28px 32px;
    width: 100%;
    max-width: 340px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(108,99,255,0.3);
    animation: pop 0.3s ease;
  }
  .modal-box .modal-icon { font-size: 64px; margin-bottom: 16px; line-height: 1; }
  .modal-box h2 {
    font-family: 'Nunito', sans-serif;
    font-size: 26px;
    font-weight: 900;
    margin-bottom: 8px;
  }
  .modal-box p { color: var(--text-muted); font-size: 15px; margin-bottom: 28px; }
  .nickname-input {
    width: 100%;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: 'Nunito', sans-serif;
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
    color: var(--text);
    margin-bottom: 16px;
    direction: rtl;
    -webkit-appearance: none;
  }
  .nickname-input:focus { border-color: var(--primary); }
  .nickname-input::placeholder { color: var(--text-muted); font-weight: 400; }

  /* â”€â”€â”€ WORD RUN GAME â”€â”€â”€ */
  #screen-run.run-screen {
    display: none;
    flex-direction: column;
    height: calc(100vh - 110px);
    min-height: 500px;
    padding: 16px 16px 8px;
    overflow: hidden;
  }
  #screen-run.run-screen.active {
    display: flex;
  }
  #run-game {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
  }
  .run-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 12px;
    flex-shrink: 0;
  }
  .run-stats {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .run-lives { font-size: 20px; letter-spacing: 2px; }
  .run-score-disp {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 20px;
    color: var(--primary);
  }

  /* falling arena */
  .run-arena {
    flex: 1;
    min-height: 260px;
    position: relative;
    background: linear-gradient(180deg, var(--bg) 0%, var(--card) 100%);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 12px;
  }
  .run-arena-overlay {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 8px;
    background: rgba(255,255,255,0.92);
    z-index: 10;
    border-radius: var(--radius);
    text-align: center;
    padding: 20px;
  }
  .run-arena-overlay.hidden { display: none; }

  /* speed track lines (decoration) */
  .run-track-line {
    position: absolute;
    left: 50%;
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg, transparent, var(--border), transparent);
    opacity: 0.4;
  }

  /* the falling word */
  .run-word-bubble {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary);
    color: white;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    padding: 10px 24px;
    border-radius: 99px;
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(108,99,255,0.4);
    transition: top linear;
    z-index: 5;
    text-align: center;
  }
  .run-word-bubble.correct-flash {
    background: var(--green);
    box-shadow: 0 4px 20px rgba(16,185,129,0.5);
    transform: translateX(-50%) scale(1.1);
  }
  .run-word-bubble.wrong-flash {
    background: var(--accent);
    box-shadow: 0 4px 20px rgba(239,68,68,0.5);
  }

  /* danger zone at bottom of arena */
  .run-danger-zone {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 60px;
    background: linear-gradient(0deg, rgba(239,68,68,0.12), transparent);
    border-top: 2px dashed rgba(239,68,68,0.25);
  }

  /* speed indicator */
  .run-speed-bar {
    position: absolute;
    top: 8px; right: 8px;
    display: flex; flex-direction: column; align-items: flex-end; gap: 2px;
  }
  .run-speed-label { font-size: 10px; color: var(--text-muted); font-weight: 600; }
  .run-speed-dots { display: flex; gap: 3px; }
  .run-speed-dot {
    width: 8px; height: 8px;
    border-radius: 99px;
    background: var(--border);
    transition: background 0.3s;
  }
  .run-speed-dot.lit { background: var(--accent); }

  /* answer buttons */
  .run-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    flex-shrink: 0;
  }
  .run-option {
    padding: 14px 8px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    font-family: 'Rubik', sans-serif;
    font-weight: 700;
    font-size: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.12s;
    direction: ltr;
    position: relative;
    overflow: hidden;
  }
  .run-option:active { transform: scale(0.96); }
  .run-option.correct {
    border-color: var(--green);
    background: var(--green-light);
    color: #0d6e50;
  }
  .run-option.wrong {
    border-color: var(--accent);
    background: var(--accent-light);
    color: #c0002e;
  }
  .run-option:disabled { cursor: default; }

  /* countdown overlay */
  .run-countdown {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.95);
    z-index: 20;
    border-radius: var(--radius);
    font-family: 'Nunito', sans-serif;
    font-size: 80px;
    font-weight: 900;
    color: var(--primary);
    animation: pop 0.4s ease;
  }

  .run-countdown.hidden { display: none; }
    0%,100% { transform: translateX(-50%); }
    25% { transform: translateX(calc(-50% - 6px)); }
    75% { transform: translateX(calc(-50% + 6px)); }
  }
  .run-word-bubble.shake { animation: word-shake 0.3s ease; }

  .nav-username {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 8px;
    transition: background 0.2s;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .nav-username:hover { background: var(--border); }

  /* â”€â”€â”€ LISTEN GAME â”€â”€â”€ */
  .listen-speak-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 28px 20px 20px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 20px;
    position: relative;
  }
  .listen-hebrew {
    font-size: 15px;
    color: var(--text-muted);
    font-weight: 600;
    min-height: 22px;
    transition: opacity 0.3s;
    direction: rtl;
  }
  .listen-hebrew.visible { color: var(--primary); font-size: 18px; }
  .listen-play-btn {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: var(--primary);
    border: none;
    cursor: pointer;
    font-size: 36px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 6px 24px rgba(108,99,255,0.4);
    transition: all 0.15s;
    position: relative;
  }
  .listen-play-btn:active { transform: scale(0.93); }
  .listen-play-btn.speaking {
    background: var(--accent);
    animation: pulse-speak 0.6s ease infinite alternate;
  }
  @keyframes pulse-speak {
    from { box-shadow: 0 6px 24px rgba(239,68,68,0.3); transform: scale(1); }
    to   { box-shadow: 0 6px 36px rgba(239,68,68,0.6); transform: scale(1.06); }
  }
  .listen-replays {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 600;
  }
  .listen-progress {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 600;
    text-align: center;
    margin-bottom: 12px;
  }

  .listen-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .listen-word-btn {
    padding: 18px 8px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    direction: ltr;
    line-height: 1.2;
  }
  .listen-word-btn:hover:not(:disabled) {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
    transform: translateY(-2px);
  }
  .listen-word-btn.correct {
    border-color: var(--green);
    background: var(--green-light);
    color: #0d6e50;
    animation: pop 0.3s ease;
  }
  .listen-word-btn.wrong {
    border-color: var(--accent);
    background: var(--accent-light);
    color: #c0002e;
    animation: shake 0.35s ease;
  }
  .listen-word-btn.found {
    border-color: var(--green);
    background: var(--green-light);
    color: #0d6e50;
    opacity: 0.5;
    cursor: default;
  }
  .listen-word-btn:disabled { cursor: default; }

  /* score popup */
  .listen-pts-popup {
    position: absolute;
    top: 12px; right: 16px;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    color: var(--green);
    pointer-events: none;
    animation: float-up 0.8s ease forwards;
    opacity: 0;
  }
  @keyframes float-up {
    0%   { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-40px); }
  }
  /* â”€â”€â”€ COLORS GAME â”€â”€â”€ */
  .colors-speak-area {
    text-align: center;
    padding: 24px 16px 20px;
    position: relative;
  }
  .colors-question {
    font-family: 'Nunito', sans-serif;
    font-size: 22px;
    font-weight: 900;
    margin-bottom: 20px;
    color: var(--text);
    direction: rtl;
  }
  .colors-speak-btn {
    width: 100px; height: 100px;
    border-radius: 50%;
    background: var(--primary);
    border: none;
    cursor: pointer;
    font-size: 44px;
    display: inline-flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 30px rgba(108,99,255,0.45);
    transition: transform 0.15s;
    margin-bottom: 12px;
  }
  .colors-speak-btn:active { transform: scale(0.92); }
  .colors-speak-btn.speaking {
    background: var(--accent);
    animation: pulse-speak 0.6s ease infinite alternate;
  }
  .colors-hint {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 600;
    direction: rtl;
    min-height: 20px;
  }

  .colors-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding: 0 4px 20px;
  }
  .color-swatch {
    aspect-ratio: 1;
    border-radius: 20px;
    border: 4px solid transparent;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
    box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    position: relative;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }
  .color-swatch:active { transform: scale(0.94); }
  .color-swatch:hover  { transform: scale(1.04); box-shadow: 0 6px 20px rgba(0,0,0,0.22); }
  .color-swatch.correct {
    border-color: #22c55e;
    animation: swatch-pop 0.4s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow: 0 0 0 6px rgba(34,197,94,0.3);
  }
  .color-swatch.wrong {
    animation: shake 0.35s ease;
    border-color: #ef4444;
    box-shadow: 0 0 0 6px rgba(239,68,68,0.3);
  }
  .color-swatch .swatch-label {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 13px;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 1px 4px rgba(0,0,0,0.5);
    letter-spacing: 0.5px;
    pointer-events: none;
    opacity: 0; /* hidden by default â€” revealed on correct */
    transition: opacity 0.3s;
  }
  .color-swatch.correct .swatch-label { opacity: 1; }

  /* celebration overlay on the speak area */
  .colors-celebrate {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 64px;
    pointer-events: none;
    animation: celebrate-pop 0.6s ease forwards;
    opacity: 0;
  }
  @keyframes celebrate-pop {
    0%   { opacity: 0; transform: scale(0.3); }
    50%  { opacity: 1; transform: scale(1.3); }
    100% { opacity: 0; transform: scale(1); }
  }
  @keyframes swatch-pop {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.18); }
    100% { transform: scale(1); }
  }

  /* score + streak display */
  .colors-hud {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 4px;
  }
  .colors-hud-item {
    text-align: center;
  }
  .colors-hud-val {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 28px;
    color: var(--primary);
    line-height: 1;
  }
  .colors-hud-label {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 600;
    margin-top: 2px;
  /* â”€â”€â”€ EMOJI GAME â”€â”€â”€ */
  #screen-emoji { padding: 16px 16px 24px; }

  /* â”€â”€ Setup screen â”€â”€ */
  .emoji-cat-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }
  .emoji-cat-btn {
    padding: 14px 8px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    font-family: 'Rubik', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    color: var(--text-muted);
  }
  .emoji-cat-btn.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }
  .emoji-cat-btn.mix-btn { grid-column: 1 / -1; }
  .emoji-cat-btn .cat-emoji { font-size: 26px; display: block; margin-bottom: 4px; }

  /* â”€â”€ In-game HUD â”€â”€ */
  .emoji-hud {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 40px;
    padding: 8px 0 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }
  .emoji-hud-block { text-align: center; }
  .emoji-hud-val {
    display: block;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 26px;
    color: var(--primary);
    line-height: 1.1;
  }
  .emoji-hud-label {
    display: block;
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 600;
    margin-top: 2px;
  }

  /* â”€â”€ Speak row â”€â”€ */
  .emoji-speak-row {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 10px 4px 10px;
    justify-content: center;
  }
  .emoji-speak-btn {
    flex-shrink: 0;
    width: 64px; height: 64px;
    border-radius: 50%;
    background: var(--primary);
    border: none;
    cursor: pointer;
    font-size: 30px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 18px rgba(108,99,255,0.4);
    transition: transform 0.15s;
  }
  .emoji-speak-btn:active { transform: scale(0.91); }
  .emoji-speak-btn.speaking {
    background: var(--accent);
    animation: pulse-speak 0.6s ease infinite alternate;
  }
  .emoji-speak-text { text-align: right; direction: rtl; }
  .emoji-question {
    font-family: 'Nunito', sans-serif;
    font-size: 17px;
    font-weight: 900;
    color: var(--text);
    margin: 0 0 2px;
  }
  .emoji-hint { font-size: 13px; color: var(--text-muted); font-weight: 600; }

  /* â”€â”€ Emoji cat selector â”€â”€ */
  #emojiCatSelector {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 8px;
    margin-bottom: 16px;
  }
  .emoji-cat-btn {
    padding: 14px 8px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card);
    font-family: 'Rubik', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    color: var(--text-muted);
    display: block;
    width: 100%;
    box-sizing: border-box;
  }
  .emoji-cat-btn.selected {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }
  .emoji-cat-btn.mix-btn { grid-column: 1 / -1; }
  .emoji-cat-btn .cat-emoji { font-size: 26px; display: block; margin-bottom: 4px; }

  /* â”€â”€ HUD â”€â”€ */
  .emoji-hud {
    display: flex !important;
    flex-direction: row !important;
    justify-content: center;
    align-items: center;
    gap: 40px;
    padding: 8px 0 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }
  .emoji-hud-block { text-align: center; }
  .emoji-hud-val { display: block; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 26px; color: var(--primary); }
  .emoji-hud-label { display: block; font-size: 11px; color: var(--text-muted); font-weight: 600; margin-top: 2px; }

  /* â”€â”€ Speak row â”€â”€ */
  .emoji-speak-row {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 10px 4px 10px;
    justify-content: center;
  }
  .emoji-speak-btn {
    flex-shrink: 0;
    width: 64px; height: 64px;
    border-radius: 50%;
    background: var(--primary);
    border: none;
    cursor: pointer;
    font-size: 30px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 18px rgba(108,99,255,0.4);
    transition: transform 0.15s;
  }
  .emoji-speak-btn:active { transform: scale(0.91); }
  .emoji-speak-btn.speaking { background: var(--accent); animation: pulse-speak 0.6s ease infinite alternate; }
  .emoji-speak-text { text-align: right; direction: rtl; }
  .emoji-question { font-family: 'Nunito', sans-serif; font-size: 17px; font-weight: 900; color: var(--text); margin: 0 0 2px; }
  .emoji-hint { font-size: 13px; color: var(--text-muted); font-weight: 600; }

  /* â”€â”€ Grid: same approach as working test â”€â”€ */
  .emoji-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    width: 100%;
  }
  .emoji-tile {
    background: var(--card);
    border: 3px solid var(--border);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.15s, border-color 0.15s, background 0.15s;
    /* width & height set by JS */
  }
  .emoji-tile .tile-icon { display: block; line-height: 1; text-align: center; /* font-size set by JS */ }
  .emoji-tile .tile-label { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 12px; color: var(--text-muted); display: block; opacity: 0; transition: opacity 0.3s; }
  .emoji-tile:active { transform: scale(0.93); }
  .emoji-tile.correct { border-color: var(--green) !important; background: var(--green-light) !important; box-shadow: 0 0 0 4px rgba(34,197,94,0.25); animation: swatch-pop 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  .emoji-tile.correct .tile-label { opacity: 1; color: #0d6e50; }
  .emoji-tile.wrong { border-color: var(--accent) !important; background: var(--accent-light) !important; animation: shake 0.35s ease; }</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NICKNAME MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="nicknameModal">
  <div class="modal-box">
    <div class="modal-icon">ğŸ‘‹</div>
    <h2>×”×™×™! ××” ×©××š?</h2>
    <p>×‘×—×¨ ×›×™× ×•×™ ×©×™×•×¤×™×¢ ×‘××¤×œ×™×§×¦×™×”</p>
    <input class="nickname-input" id="nicknameInput" type="text" placeholder="×›×™× ×•×™ ×©×œ×š..." maxlength="16">
    <button class="btn-primary" onclick="saveNickname()" style="margin-bottom:0">×‘×•××• × ×ª×—×™×œ! ğŸš€</button>
  </div>
</div>

<nav>
  <div class="logo">Word<span>Up</span> ğŸš€</div>
  <div class="nav-score">
    <span class="nav-username" id="navUsername" onclick="openNicknameModal()" title="×©× ×” ×›×™× ×•×™">ğŸ‘¤</span>
    <button id="sfx-btn" onclick="toggleSfx()" title="×›×‘×” ×¦×œ×™×œ×™×" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px;">ğŸ”Š</button>
    <div class="streak-pill" id="navStreak">ğŸ”¥ <span id="streakVal">0</span></div>
    <div class="score-pill">â­ <span id="totalScore">0</span></div>
  </div>
</nav>

<div class="tabs">
  <button class="tab active" onclick="showTab('home')">ğŸ  ×‘×™×ª</button>
  <button class="tab" onclick="showTab('mc')">ğŸ¯ ××•×œ×˜×™-×¦'×•×™×¡</button>
  <button class="tab" onclick="showTab('flash')">ğŸƒ ×¤×œ××©×§××¨×“×¡</button>
  <button class="tab" onclick="showTab('fill')">âœï¸ ×”×©×œ××”</button>
  <button class="tab" onclick="showTab('match')">ğŸ”— ×”×ª×××”</button>
  <button class="tab" onclick="showTab('run')">ğŸƒ ×¨×™×¦×”</button>
  <button class="tab" onclick="showTab('listen')">ğŸ”Š ×”××–× ×”</button>
  <button class="tab" onclick="showTab('colors')">ğŸ¨ ×¦×‘×¢×™×</button>
  <button class="tab" onclick="showTab('emoji')">ğŸ˜€ ×ª××•× ×•×ª</button>
  <button class="tab" onclick="showTab('stats')">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-home" class="screen active">
  <div class="hero">
    <h1 id="heroGreeting">×©×œ×•×! ğŸ‘‹<br>×‘×•× × ×œ××“ ×× ×’×œ×™×ª</h1>
    <p>×‘×—×¨ ×¨××” ×•××©×—×§ â€” ×•×¦×‘×•×¨ × ×§×•×“×•×ª!</p>
  </div>

  <!-- Controls row: Pack button + Level dropdown + Sources dropdown -->
  <div class="home-controls">
    <button class="ctrl-btn packs-btn" onclick="showTab2('custom')">ğŸ“¦</button>

    <!-- Level picker -->
    <div style="position:relative; flex:1">
      <button class="ctrl-btn" id="levelBtn" onclick="toggleDropdown('levelDrop',this)" style="width:100%">
        ğŸ“š <span id="levelBtnLabel">×¨××” 1 â€” ××ª×—×™×œ</span> â–¾
      </button>
      <div class="dropdown-panel" id="levelDrop">
        <div class="dropdown-item selected" id="lvlOpt1" onclick="selectLevelDrop(1)">1 â€” ××ª×—×™×œ</div>
        <div class="dropdown-item" id="lvlOpt2" onclick="selectLevelDrop(2)">2 â€” ×™×¡×•×“×™</div>
        <div class="dropdown-item" id="lvlOpt3" onclick="selectLevelDrop(3)">3 â€” ×‘×™× ×•× ×™</div>
        <div class="dropdown-item" id="lvlOpt4" onclick="selectLevelDrop(4)">4 â€” ××ª×§×“×</div>
      </div>
    </div>

    <!-- Sources picker -->
    <div style="position:relative; flex:1">
      <button class="ctrl-btn" id="sourcesBtn" onclick="toggleDropdown('sourcesDrop',this)" style="width:100%">
        ğŸ® <span id="sourcesBtnLabel">××§×•×¨×•×ª</span> â–¾
      </button>
      <div class="dropdown-panel" id="sourcesDrop" style="min-width:200px; right:0; left:auto">
        <div class="dropdown-item" id="src-builtin" onclick="toggleSource('builtin')">
          <span class="chk">âœ“</span> ××™×œ×™× ××•×‘× ×•×ª
        </div>
        <hr class="dropdown-divider">
        <div id="srcCustomList"></div>
        <div id="srcEmptyMsg" style="padding:10px 16px;font-size:12px;color:var(--text-muted)">××™×Ÿ ×—×‘×™×œ×•×ª ××™×©×™×•×ª ×¢×“×™×™×Ÿ</div>
      </div>
    </div>
  </div>

  <p style="font-weight:700; font-size:15px; margin-bottom:12px;">ğŸ® ×‘×—×¨ ××©×—×§</p>
  <div class="game-cards">
    <div class="game-card" onclick="startGame('mc')">
      <div class="game-icon">ğŸ¯</div>
      <div class="game-name">××•×œ×˜×™-×¦'×•×™×¡</div>
      <div class="game-desc">4 ××¤×©×¨×•×™×•×ª, 1 ×ª×©×•×‘×” × ×›×•× ×”</div>
      <div class="game-score">×©×™×: <span id="home-mc-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('flash')">
      <div class="game-icon">ğŸƒ</div>
      <div class="game-name">×¤×œ××©×§××¨×“×¡</div>
      <div class="game-desc">×”×¤×•×š ×›×¨×˜×™×¡ ×•×’×œ×” ××™×œ×™×</div>
      <div class="game-score">×©×™×: <span id="home-flash-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('fill')">
      <div class="game-icon">âœï¸</div>
      <div class="game-name">×”×©×œ××ª ××©×¤×˜</div>
      <div class="game-desc">×”×©×œ× ××ª ×”××™×œ×” ×”×—×¡×¨×”</div>
      <div class="game-score">×©×™×: <span id="home-fill-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('match')">
      <div class="game-icon">ğŸ”—</div>
      <div class="game-name">×”×ª×××”</div>
      <div class="game-desc">×—×‘×¨ ×¢×‘×¨×™×ª ×œ×× ×’×œ×™×ª</div>
      <div class="game-score">×©×™×: <span id="home-match-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('run')">
      <div class="game-icon">ğŸƒ</div>
      <div class="game-name">Word Run</div>
      <div class="game-desc">×¢×¦×•×¨ ××ª ×”××™×œ×” ×”× ×•×¤×œ×ª!</div>
      <div class="game-score">×©×™×: <span id="home-run-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('listen')">
      <div class="game-icon">ğŸ”Š</div>
      <div class="game-name">×”××–× ×”</div>
      <div class="game-desc">×©××¢ ×•×–×”×” ××ª ×”××™×œ×”</div>
      <div class="game-score">×©×™×: <span id="home-listen-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('colors')">
      <div class="game-icon">ğŸ¨</div>
      <div class="game-name">×¦×‘×¢×™×</div>
      <div class="game-desc">×œ×§×˜× ×™× â€” ×©××¢ ×•×’×¢ ×‘×¦×‘×¢!</div>
      <div class="game-score">×©×™×: <span id="home-colors-best">0</span></div>
    </div>
    <div class="game-card" onclick="startGame('emoji')">
      <div class="game-icon">ğŸ˜€</div>
      <div class="game-name">×ª××•× ×•×ª</div>
      <div class="game-desc">×©××¢ ×•×’×¢ ×‘×ª××•× ×” ×”× ×›×•× ×”!</div>
      <div class="game-score">×©×™×: <span id="home-emoji-best">0</span></div>
    </div>
  </div>

  <div id="addWordsSection" style="margin-top:8px;">
    <button class="btn-secondary" onclick="addWordPack()" id="addWordsBtn">
      â• ×”×•×¡×£ ××™×œ×™× × ×•×¡×¤×•×ª ×œ×¨××” <span id="addLevelLabel">1</span>
    </button>
    <p class="words-remaining" id="wordsRemaining"></p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MULTIPLE CHOICE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-mc" class="screen">
  <div id="mc-game">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('mc')">â†</button>
      <span class="game-title">ğŸ¯ ××•×œ×˜×™-×¦'×•×™×¡</span>
      <span class="game-progress" id="mc-progress">1 / 10</span>
    </div>
    <div class="dir-toggle">
      <button class="dir-btn active" id="mc-dir-he" onclick="setMCDir(false)">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª â† ×× ×’×œ×™×ª</button>
      <button class="dir-btn" id="mc-dir-en" onclick="setMCDir(true)">ğŸ‡¬ğŸ‡§ ×× ×’×œ×™×ª â† ×¢×‘×¨×™×ª</button>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="mc-bar" style="width:10%"></div>
    </div>
    <div class="word-card">
      <div class="word-label" id="mc-word-label">××” ×”×ª×¨×’×•× ×©×œ:</div>
      <div class="word-main" id="mc-word">â€”</div>
      <div class="word-example" id="mc-example"></div>
    </div>
    <div class="options-grid" id="mc-options"></div>
    <div class="feedback-banner" id="mc-feedback"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="next-btn" id="mc-next" onclick="mcNext()" style="flex:1;margin:0">×”×‘× â†</button>
      <button onclick="confirmRestart('mc')" style="background:none;border:2px solid var(--border);border-radius:var(--radius-sm);padding:0 14px;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
    </div>
  </div>

  <div id="mc-results" class="results" style="display:none">
    <div class="results-icon" id="mc-res-icon">ğŸ‰</div>
    <h2 id="mc-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="mc-res-msg">×¡×™×™××ª ×¡×™×‘×•×‘ ××•×œ×˜×™-×¦'×•×™×¡</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="mc-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="mc-res-correct">0</div>
        <div class="stat-label">× ×›×•×Ÿ</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="mc-res-streak">0</div>
        <div class="stat-label">×©×™× ×¨×¦×£</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('mc')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FLASHCARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-flash" class="screen">
  <div id="flash-game">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('flash')">â†</button>
      <span class="game-title">ğŸƒ ×¤×œ××©×§××¨×“×¡</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="game-progress" id="flash-progress">1 / 10</span>
        <button onclick="confirmRestart('flash')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
      </div>
    </div>
    <div class="dir-toggle">
      <button class="dir-btn active" id="fl-dir-he" onclick="setFlDir(false)">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª â† ×× ×’×œ×™×ª</button>
      <button class="dir-btn" id="fl-dir-en" onclick="setFlDir(true)">ğŸ‡¬ğŸ‡§ ×× ×’×œ×™×ª â† ×¢×‘×¨×™×ª</button>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="flash-bar" style="width:10%"></div>
    </div>
    <div class="flashcard-wrap" onclick="flipCard()">
      <div class="flashcard" id="flashcard">
        <div class="card-face card-front">
          <div class="word" id="flash-word">â€”</div>
          <div class="hint">×œ×—×¥ ×œ×”×¤×•×š ğŸ‘†</div>
        </div>
        <div class="card-face card-back">
          <div class="word" id="flash-answer">â€”</div>
          <div class="example" id="flash-example"></div>
        </div>
      </div>
    </div>
    <div class="flash-actions">
      <button class="flash-btn didnt" id="flash-didnt" onclick="flashAnswer(false)">âŒ ×œ× ×™×“×¢×ª×™</button>
      <button class="flash-btn knew" id="flash-knew" onclick="flashAnswer(true)">âœ… ×™×“×¢×ª×™!</button>
    </div>
  </div>

  <div id="flash-results" class="results" style="display:none">
    <div class="results-icon">ğŸƒ</div>
    <h2 id="flash-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="flash-res-msg">×¡×™×™××ª ×¡×™×‘×•×‘ ×¤×œ××©×§××¨×“×¡</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="flash-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="flash-res-knew">0</div>
        <div class="stat-label">×™×“×¢×ª×™</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="flash-res-pct">0%</div>
        <div class="stat-label">××—×•×– ×”×¦×œ×—×”</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('flash')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FILL IN THE BLANK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-fill" class="screen">
  <div id="fill-game">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('fill')">â†</button>
      <span class="game-title">âœï¸ ×”×©×œ××ª ××©×¤×˜</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="game-progress" id="fill-progress">1 / 10</span>
        <button onclick="confirmRestart('fill')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
      </div>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="fill-bar" style="width:10%"></div>
    </div>
    <div class="sentence-card">
      <div class="word-label">×”×©×œ× ××ª ×”××™×œ×” ×”×—×¡×¨×”</div>
      <div class="sentence-text" id="fill-sentence">â€”</div>
      <div class="translation-flash" id="fill-translation"></div>
    </div>
    <div class="options-grid" id="fill-options"></div>
    <div class="feedback-banner" id="fill-feedback"></div>
    <button class="next-btn" id="fill-next" onclick="fillNext()">×”×‘× â†</button>
  </div>

  <div id="fill-results" class="results" style="display:none">
    <div class="results-icon" id="fill-res-icon">ğŸ‰</div>
    <h2 id="fill-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="fill-res-msg">×¡×™×™××ª ×¡×™×‘×•×‘ ×”×©×œ××ª ××©×¤×˜</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="fill-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="fill-res-correct">0</div>
        <div class="stat-label">× ×›×•×Ÿ</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="fill-res-streak">0</div>
        <div class="stat-label">×©×™× ×¨×¦×£</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('fill')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATCH GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-match" class="screen">
  <div id="match-game">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('match')">â†</button>
      <span class="game-title">ğŸ”— ×”×ª×××”</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="match-pairs-left" id="match-pairs-left"></span>
        <button onclick="confirmRestart('match')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
      </div>
    </div>

    <div class="match-config">
      <label>×›××” ××™×œ×™×?</label>
      <div class="match-count-btns">
        <button class="match-count-btn" onclick="setMatchCount(4,this)">4</button>
        <button class="match-count-btn selected" onclick="setMatchCount(6,this)">6</button>
        <button class="match-count-btn" onclick="setMatchCount(8,this)">8</button>
        <button class="match-count-btn" onclick="setMatchCount(10,this)">10</button>
      </div>
    </div>

    <div class="match-timer-bar">
      <div class="match-timer" id="match-timer">0:00</div>
      <div class="progress-bar-wrap" style="flex:1;margin:0">
        <div class="progress-bar" id="match-progress-bar" style="width:0%"></div>
      </div>
    </div>

    <div class="match-columns">
      <div class="match-col" id="match-col-he"></div>
      <div class="match-col" id="match-col-en"></div>
    </div>

    <div class="feedback-banner" id="match-feedback"></div>
  </div>

  <div id="match-results" class="results" style="display:none">
    <div class="results-icon" id="match-res-icon">ğŸ‰</div>
    <h2 id="match-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="match-res-msg">×¡×™×™××ª ××ª ×”×”×ª×××”!</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="match-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="match-res-time">0:00</div>
        <div class="stat-label">×–××Ÿ</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="match-res-errors">0</div>
        <div class="stat-label">×˜×¢×•×™×•×ª</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('match')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORD RUN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-run" class="screen run-screen">
  <div id="run-game" style="display:flex;flex-direction:column;height:100%">
    <div class="run-header">
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn-back" onclick="confirmLeaveGame('run')">â†</button>
        <span style="font-weight:700;font-size:17px;">ğŸƒ Word Run</span>
      </div>
      <div class="run-stats">
        <span class="run-lives" id="run-lives">â¤ï¸â¤ï¸â¤ï¸</span>
        <span class="run-score-disp" id="run-score-disp">0</span>
        <button onclick="confirmRestart('run')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
      </div>
    </div>

    <!-- Falling arena -->
    <div class="run-arena" id="runArena">
      <div class="run-track-line" style="left:33%"></div>
      <div class="run-track-line" style="left:67%"></div>
      <div class="run-danger-zone"></div>
      <div class="run-speed-bar">
        <span class="run-speed-label">××”×™×¨×•×ª</span>
        <div class="run-speed-dots">
          <div class="run-speed-dot" id="spd1"></div>
          <div class="run-speed-dot" id="spd2"></div>
          <div class="run-speed-dot" id="spd3"></div>
          <div class="run-speed-dot" id="spd4"></div>
          <div class="run-speed-dot" id="spd5"></div>
        </div>
      </div>
      <!-- Countdown overlay -->
      <div class="run-countdown hidden" id="runCountdown"></div>
      <!-- Paused overlay -->
      <div class="run-arena-overlay hidden" id="runPausedOverlay">
        <div style="font-size:48px">â¸ï¸</div>
        <p style="font-weight:700;font-size:18px">××•×©×”×”</p>
        <p style="color:var(--text-muted);font-size:14px">×™×¦××ª ××”××©×—×§ â€” ×œ×—×¥ ××©×—×§ ×©×•×‘ ×œ×”××©×™×š</p>
      </div>
    </div>

    <!-- Answer options -->
    <div class="run-options" id="runOptions"></div>
  </div>

  <div id="run-results" class="results" style="display:none">
    <div class="results-icon" id="run-res-icon">ğŸ’€</div>
    <h2 id="run-res-title">× ×’××¨×• ×”×œ×‘×‘×•×ª!</h2>
    <p id="run-res-msg">××œ ×ª×•×•×ª×¨ â€” × ×¡×” ×©×•×‘!</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="run-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="run-res-words">0</div>
        <div class="stat-label">××™×œ×™×</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="run-res-streak">0</div>
        <div class="stat-label">×©×™× ×¨×¦×£</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('run')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LISTEN GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-listen" class="screen">
  <div id="listen-game">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('listen')">â†</button>
      <span class="game-title">ğŸ”Š ×”××–× ×”</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="game-progress" id="listen-progress">1 / 10</span>
        <button onclick="confirmRestart('listen')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
      </div>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="listen-bar" style="width:10%"></div>
    </div>

    <!-- Speak area -->
    <div class="listen-speak-area">
      <p style="font-size:14px;color:var(--text-muted);font-weight:600;margin:0">××” ×”××™×œ×” ×©× ×××¨×ª?</p>
      <button class="listen-play-btn" id="listenPlayBtn" onclick="listenSpeak()">ğŸ”Š</button>
      <span class="listen-replays" id="listenReplays"></span>
      <div class="listen-hebrew" id="listenHebrew"></div>
    </div>

    <!-- Word grid -->
    <div class="listen-progress" id="listenFoundMsg"></div>
    <div class="listen-grid" id="listenGrid"></div>
    <div class="feedback-banner" id="listen-feedback"></div>
  </div>

  <div id="listen-results" class="results" style="display:none">
    <div class="results-icon" id="listen-res-icon">ğŸ‰</div>
    <h2 id="listen-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="listen-res-msg">×¡×™×™××ª ××ª ××©×—×§ ×”×”××–× ×”!</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="listen-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="listen-res-correct">0</div>
        <div class="stat-label">× ×›×•×Ÿ ××”× ×™×¡×™×•×Ÿ ×”×¨××©×•×Ÿ</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="listen-res-replays">0</div>
        <div class="stat-label">×”×©××¢×•×ª ×—×•×–×¨×•×ª</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('listen')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COLORS GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-colors" class="screen">
  <div id="colors-game">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('colors')">â†</button>
      <span class="game-title">ğŸ¨ ×¦×‘×¢×™×</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="game-progress" id="colors-progress">1 / 10</span>
        <button onclick="confirmRestart('colors')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)" title="×”×ª×—×œ ××—×“×©">â†º</button>
      </div>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="colors-bar" style="width:10%"></div>
    </div>

    <!-- HUD -->
    <div class="colors-hud">
      <div class="colors-hud-item">
        <div class="colors-hud-val" id="colors-score-disp">0</div>
        <div class="colors-hud-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="colors-hud-item">
        <div class="colors-hud-val" id="colors-streak-disp">0ğŸ”¥</div>
        <div class="colors-hud-label">×¨×¦×£</div>
      </div>
    </div>

    <!-- Speak area -->
    <div class="colors-speak-area">
      <p class="colors-question" id="colorsQuestion">×œ×—×¥ ×›×“×™ ×œ×©××•×¢ ××ª ×”×¦×‘×¢! ğŸ‘†</p>
      <button class="colors-speak-btn" id="colorsSpeakBtn" onclick="colorsSpeak()">ğŸ”Š</button>
      <div class="colors-hint" id="colorsHint">×œ×—×¥ ×¢×œ ×”×¦×‘×¢ ×”× ×›×•×Ÿ</div>
    </div>

    <!-- Color swatches grid -->
    <div class="colors-grid" id="colorsGrid"></div>
  </div>

  <div id="colors-results" class="results" style="display:none">
    <div class="results-icon" id="colors-res-icon">ğŸ‰</div>
    <h2 id="colors-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="colors-res-msg">×œ××“×ª ××ª ×”×¦×‘×¢×™×!</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="colors-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="colors-res-correct">0</div>
        <div class="stat-label">× ×›×•×Ÿ ×× ×™×¡×™×•×Ÿ ×¨××©×•×Ÿ</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="colors-res-streak">0</div>
        <div class="stat-label">×©×™× ×¨×¦×£</div>
      </div>
    </div>
    <button class="btn-primary" onclick="startGame('colors')">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMOJI GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-emoji" class="screen">
  <div id="emoji-setup">
    <div class="game-header" style="margin-bottom:16px">
      <button class="btn-back" onclick="goHome()">â†</button>
      <span class="game-title">ğŸ˜€ ×ª××•× ×•×ª</span>
      <span></span>
    </div>
    <p style="font-weight:700;font-size:15px;margin-bottom:12px;direction:rtl">×‘×—×¨ ×§×˜×’×•×¨×™×•×ª:</p>
    <div class="emoji-cat-selector" id="emojiCatSelector"></div>
    <button class="btn-primary" onclick="startEmojiGame()" id="startEmojiBtn">â–¶ï¸ ×”×ª×—×œ ××©×—×§!</button>
  </div>

  <div id="emoji-game" style="display:none">
    <div class="game-header">
      <button class="btn-back" onclick="confirmLeaveGame('emoji')">â†</button>
      <span class="game-title">ğŸ˜€ ×ª××•× ×•×ª</span>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="game-progress" id="emoji-progress">1 / 10</span>
        <button onclick="confirmRestart('emoji')" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted)">â†º</button>
      </div>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="emoji-bar" style="width:10%"></div>
    </div>

    <!-- HUD -->
    <div class="emoji-hud">
      <div class="emoji-hud-block">
        <span class="emoji-hud-val" id="emoji-score-disp">0</span>
        <span class="emoji-hud-label">× ×§×•×“×•×ª â­</span>
      </div>
      <div class="emoji-hud-block">
        <span class="emoji-hud-val" id="emoji-streak-disp">0</span>
        <span class="emoji-hud-label">×¨×¦×£ ğŸ”¥</span>
      </div>
    </div>

    <!-- Speak row -->
    <div class="emoji-speak-row">
      <button class="emoji-speak-btn" id="emojiSpeakBtn" onclick="emojiSpeak()">ğŸ”Š</button>
      <div class="emoji-speak-text">
        <p class="emoji-question" id="emojiQuestion">×œ×—×¥ ×œ×”×©××¢×”</p>
        <span class="emoji-hint" id="emojiHint">×’×¢ ×‘×ª××•× ×” ×”× ×›×•× ×”</span>
      </div>
    </div>

    <!-- Emoji grid using padding-bottom trick for square tiles -->
    <div class="emoji-grid" id="emojiGrid"></div>
    <div class="feedback-banner" id="emoji-feedback" style="margin-top:8px"></div>
  </div>

  <div id="emoji-results" class="results" style="display:none">
    <div class="results-icon" id="emoji-res-icon">ğŸ‰</div>
    <h2 id="emoji-res-title">×›×œ ×”×›×‘×•×“!</h2>
    <p id="emoji-res-msg">××¢×•×œ×”!</p>
    <div class="results-stats">
      <div class="stat-box">
        <div class="stat-val" id="emoji-res-score">0</div>
        <div class="stat-label">× ×§×•×“×•×ª</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="emoji-res-correct">0</div>
        <div class="stat-label">× ×›×•×Ÿ ×× ×™×¡×™×•×Ÿ ×¨××©×•×Ÿ</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="emoji-res-streak">0</div>
        <div class="stat-label">×©×™× ×¨×¦×£</div>
      </div>
    </div>
    <button class="btn-primary" onclick="showEmojiSetup()">ğŸ”„ ×©×—×§ ×©×•×‘</button>
    <button class="btn-secondary" onclick="goHome()">â† ×—×–×•×¨ ×”×‘×™×ª×”</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CUSTOM PACKS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-custom" class="screen">
  <div class="game-header" style="margin-bottom:20px">
    <button class="btn-back" onclick="goHome()">â†</button>
    <span class="game-title">ğŸ“¦ ×—×‘×™×œ×•×ª ××™×©×™×•×ª</span>
    <span></span>
  </div>

  <!-- Existing packs list -->
  <div id="packList" class="pack-list"></div>
  <div id="noPacksMsg" class="empty-state" style="padding:20px 0;display:none">
    <div class="e-icon">ğŸ“¦</div>
    <p>××™×Ÿ ×¢×“×™×™×Ÿ ×—×‘×™×œ×•×ª ××™×©×™×•×ª.<br>×¦×•×¨ ××ª ×”×¨××©×•× ×”!</p>
  </div>

  <!-- New / Edit pack form -->
  <div class="new-pack-form" id="packForm">
    <div class="edit-pack-header">
      <h3 id="packFormTitle">â• ×—×‘×™×œ×” ×—×“×©×”</h3>
      <button id="cancelEditBtn" onclick="cancelEdit()" style="display:none;background:none;border:none;font-size:13px;color:var(--text-muted);cursor:pointer;font-weight:600;">×‘×™×˜×•×œ</button>
    </div>
    <input class="pack-name-input" id="packNameInput" type="text" placeholder="×©× ×”×—×‘×™×œ×” (×œ××©×œ: ×¤×¨×§ 3)" maxlength="30">
    <textarea class="pack-words-textarea" id="packWordsInput" placeholder="×”×›× ×¡ ××™×œ×™× â€” ××—×ª ×‘×›×œ ×©×•×¨×”:&#10;apple&#10;beautiful&#10;run - ×œ×¨×•×¥&#10;school - ×‘×™×ª ×¡×¤×¨"></textarea>
    <p class="pack-hint">
      ğŸ’¡ ××™×œ×” ×‘×œ×‘×“ â€” ×ª×ª×•×¨×’× ××•×˜×•××˜×™×ª<br>
      <strong>word - ×ª×¨×’×•×</strong> â€” × ×©××¨ ×›××•×ª ×©×”×•×
    </p>
    <div class="translate-status" id="translateStatus"></div>
    <div id="previewWrap" style="display:none">
      <p style="font-weight:700;font-size:14px;margin-bottom:8px;">âœï¸ ×¢×¨×•×š ×œ×¤× ×™ ×©××™×¨×”:</p>
      <table class="preview-table">
        <thead><tr><th>×× ×’×œ×™×ª</th><th>×¢×‘×¨×™×ª</th></tr></thead>
        <tbody id="previewBody"></tbody>
      </table>
    </div>
    <button class="btn-primary" id="translateBtn" onclick="translateAndPreview()">×ª×¨×’× ×•×‘× ×” ×—×‘×™×œ×” âœ¨</button>
    <button class="btn-primary" id="savePackBtn" onclick="savePack()" style="display:none;background:var(--green)">×©××•×¨ ×—×‘×™×œ×” âœ…</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-stats" class="screen">
  <h2 style="font-family:'Nunito',sans-serif;font-weight:900;font-size:22px;margin-bottom:20px;">ğŸ“Š ×”×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×œ×™</h2>
  <div class="stats-grid">
    <div class="big-stat">
      <div class="val" id="stat-total">0</div>
      <div class="lbl">×¡×”"×› × ×§×•×“×•×ª</div>
    </div>
    <div class="big-stat">
      <div class="val" id="stat-streak">0</div>
      <div class="lbl">ğŸ”¥ ×©×™× ×¨×¦×£</div>
    </div>
    <div class="big-stat">
      <div class="val" id="stat-games">0</div>
      <div class="lbl">××©×—×§×™×</div>
    </div>
    <div class="big-stat">
      <div class="val" id="stat-level">1</div>
      <div class="lbl">×¨××” × ×•×›×—×™×ª</div>
    </div>
  </div>

  <p style="font-weight:700;font-size:15px;margin-bottom:12px;">ğŸ“œ ×”×™×¡×˜×•×¨×™×”</p>
  <div class="history-list" id="historyList">
    <div class="empty-state">
      <div class="e-icon">ğŸ®</div>
      <p>×¢×“×™×™×Ÿ ××™×Ÿ ××©×—×§×™×.<br>×©×—×§ ××ª ×”××©×—×§ ×”×¨××©×•×Ÿ ×©×œ×š!</p>
    </div>
  </div>
  <button onclick="confirmResetHistory()" style="margin-top:16px;width:100%;padding:12px;background:none;border:2px solid var(--border);border-radius:var(--radius-sm);color:var(--text-muted);font-family:'Rubik',sans-serif;font-weight:600;font-size:14px;cursor:pointer;">
    ğŸ—‘ï¸ ××¤×¡ ×”×™×¡×˜×•×¨×™×”
  </button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORDS = {
  1: {
    packs: [
      // Pack 1 - basics
      [
        {en:"friend",he:"×—×‘×¨",ex:"She is my best friend."},
        {en:"school",he:"×‘×™×ª ×¡×¤×¨",ex:"I go to school every day."},
        {en:"food",he:"××•×›×œ",ex:"I love Italian food."},
        {en:"water",he:"××™×",ex:"Drink more water!"},
        {en:"happy",he:"×©××—",ex:"I'm so happy today!"},
        {en:"tired",he:"×¢×™×™×£",ex:"I'm really tired after school."},
        {en:"phone",he:"×˜×œ×¤×•×Ÿ",ex:"My phone needs charging."},
        {en:"music",he:"××•×–×™×§×”",ex:"I listen to music every day."},
        {en:"sport",he:"×¡×¤×•×¨×˜",ex:"Do you play any sport?"},
        {en:"book",he:"×¡×¤×¨",ex:"This book is amazing."},
        {en:"money",he:"×›×¡×£",ex:"I need money for the bus."},
        {en:"family",he:"××©×¤×—×”",ex:"My family is everything."},
        {en:"home",he:"×‘×™×ª",ex:"I want to go home."},
        {en:"time",he:"×–××Ÿ",ex:"We don't have time!"},
        {en:"night",he:"×œ×™×œ×”",ex:"Good night everyone!"},
        {en:"day",he:"×™×•×",ex:"It was a great day."},
        {en:"love",he:"××”×‘×”",ex:"Love is powerful."},
        {en:"angry",he:"×›×•×¢×¡",ex:"Why are you angry?"},
        {en:"funny",he:"××¦×—×™×§",ex:"He is so funny!"},
        {en:"cool",he:"××’× ×™×‘",ex:"That's really cool."},
        {en:"ugly",he:"××›×•×¢×¨",ex:"That's an ugly hat."},
        {en:"pretty",he:"×™×¤×”",ex:"What a pretty view!"},
        {en:"fast",he:"××”×™×¨",ex:"Run as fast as you can!"},
        {en:"slow",he:"××™×˜×™",ex:"The turtle is very slow."},
        {en:"big",he:"×’×“×•×œ",ex:"It's a big problem."},
        {en:"small",he:"×§×˜×Ÿ",ex:"My room is small."},
        {en:"hard",he:"×§×©×”",ex:"Math is really hard."},
        {en:"easy",he:"×§×œ",ex:"This test was easy."},
        {en:"late",he:"×××•×—×¨",ex:"I'm always late."},
        {en:"early",he:"××•×§×“×",ex:"Wake up early tomorrow."},
        {en:"hot",he:"×—×",ex:"The weather is so hot."},
        {en:"cold",he:"×§×¨",ex:"It's freezing cold outside."},
        {en:"good",he:"×˜×•×‘",ex:"Have a good day!"},
        {en:"bad",he:"×¨×¢",ex:"That was a bad idea."},
        {en:"new",he:"×—×“×©",ex:"I got a new phone."},
        {en:"old",he:"×™×©×Ÿ",ex:"This is an old song."},
        {en:"right",he:"× ×›×•×Ÿ",ex:"You're absolutely right."},
        {en:"wrong",he:"×œ× × ×›×•×Ÿ",ex:"That's the wrong answer."},
        {en:"loud",he:"×¨×•×¢×©",ex:"The music is too loud."},
        {en:"quiet",he:"×©×§×˜",ex:"Please be quiet."},
        {en:"free",he:"×—×™× × / ×—×•×¤×©×™",ex:"Is this app free?"},
        {en:"busy",he:"×¢×¡×•×§",ex:"Sorry, I'm really busy."},
        {en:"bored",he:"××©×•×¢××",ex:"I'm so bored!"},
        {en:"scared",he:"××¤×•×—×“",ex:"Are you scared?"},
        {en:"hungry",he:"×¨×¢×‘",ex:"I'm so hungry right now."},
        {en:"thirsty",he:"×¦××",ex:"I'm really thirsty."},
        {en:"sick",he:"×—×•×œ×”",ex:"I feel sick today."},
        {en:"strong",he:"×—×–×§",ex:"Be strong!"},
        {en:"weak",he:"×—×œ×©",ex:"I feel weak today."},
        {en:"lost",he:"××‘×•×“",ex:"I'm completely lost."},
      ],
      // Pack 2 - school & social
      [
        {en:"class",he:"×›×™×ª×”",ex:"What class are you in?"},
        {en:"teacher",he:"××•×¨×”",ex:"My teacher is great."},
        {en:"test",he:"××‘×—×Ÿ",ex:"I have a test tomorrow."},
        {en:"homework",he:"×©×™×¢×•×¨×™ ×‘×™×ª",ex:"Did you do your homework?"},
        {en:"break",he:"×”×¤×¡×§×”",ex:"I can't wait for the break."},
        {en:"grade",he:"×¦×™×•×Ÿ",ex:"I got a great grade!"},
        {en:"subject",he:"××§×¦×•×¢",ex:"What's your favorite subject?"},
        {en:"answer",he:"×ª×©×•×‘×”",ex:"I don't know the answer."},
        {en:"question",he:"×©××œ×”",ex:"Good question!"},
        {en:"explain",he:"×œ×”×¡×‘×™×¨",ex:"Can you explain this?"},
        {en:"understand",he:"×œ×”×‘×™×Ÿ",ex:"I don't understand."},
        {en:"forget",he:"×œ×©×›×•×—",ex:"Don't forget your bag!"},
        {en:"remember",he:"×œ×–×›×•×¨",ex:"Do you remember me?"},
        {en:"follow",he:"×œ×¢×§×•×‘",ex:"Follow me on Instagram."},
        {en:"share",he:"×œ×©×ª×£",ex:"Share this post!"},
        {en:"like",he:"×œ××”×•×‘ / ×œ×—×‘×‘",ex:"I like this song."},
        {en:"comment",he:"×ª×’×•×‘×”",ex:"Leave a comment below."},
        {en:"message",he:"×”×•×“×¢×”",ex:"I got your message."},
        {en:"chat",he:"×©×™×—×” / ×¦'××˜",ex:"Let's chat later."},
        {en:"call",he:"×œ×”×ª×§×©×¨",ex:"I'll call you later."},
        {en:"meet",he:"×œ×”×™×¤×’×©",ex:"Let's meet at the mall."},
        {en:"party",he:"××¡×™×‘×”",ex:"Are you coming to the party?"},
        {en:"invite",he:"×œ×”×–××™×Ÿ",ex:"Can you invite everyone?"},
        {en:"laugh",he:"×œ×¦×—×•×§",ex:"That made me laugh."},
        {en:"cry",he:"×œ×‘×›×•×ª",ex:"Don't cry."},
        {en:"smile",he:"×œ×—×™×™×š",ex:"Just smile!"},
        {en:"argue",he:"×œ×”×ª×•×•×›×—",ex:"We always argue."},
        {en:"agree",he:"×œ×”×¡×›×™×",ex:"I totally agree."},
        {en:"honest",he:"×›×Ÿ / ×™×©×¨",ex:"Be honest with me."},
        {en:"trust",he:"×××•×Ÿ / ×œ×¡××•×š",ex:"I trust you."},
        {en:"secret",he:"×¡×•×“",ex:"Can you keep a secret?"},
        {en:"popular",he:"×¤×•×¤×•×œ×¨×™",ex:"She's very popular."},
        {en:"boring",he:"××©×¢××",ex:"This class is boring."},
        {en:"nervous",he:"×¢×¦×‘× ×™",ex:"I'm so nervous!"},
        {en:"excited",he:"××ª×¨×’×©",ex:"I'm excited about the trip."},
        {en:"proud",he:"×’××”",ex:"I'm proud of you."},
        {en:"jealous",he:"××§× ×",ex:"Are you jealous?"},
        {en:"kind",he:"××“×™×‘ / × ×—××“",ex:"That's so kind of you."},
        {en:"rude",he:"×’×¡ ×¨×•×—",ex:"Don't be rude."},
        {en:"weird",he:"××•×–×¨",ex:"That's really weird."},
        {en:"serious",he:"×¨×¦×™× ×™",ex:"Are you serious?"},
        {en:"hate",he:"×œ×©× ×•×",ex:"I hate Mondays."},
        {en:"miss",he:"×œ×’×¢×’×¢",ex:"I miss my friends."},
        {en:"alone",he:"×œ×‘×“",ex:"I feel so alone."},
        {en:"together",he:"×‘×™×—×“",ex:"We're better together."},
        {en:"support",he:"×ª××™×›×”",ex:"Thank you for your support."},
        {en:"help",he:"×¢×–×¨×”",ex:"I need your help."},
        {en:"ignore",he:"×œ×”×ª×¢×œ×",ex:"Stop ignoring me!"},
        {en:"blame",he:"×œ×”××©×™×",ex:"Don't blame me."},
        {en:"apologize",he:"×œ×”×ª× ×¦×œ",ex:"You should apologize."},
      ],
      // Pack 3 - entertainment & tech
      [
        {en:"game",he:"××©×—×§",ex:"Let's play a game."},
        {en:"video",he:"×•×™×“××•",ex:"Watch this video!"},
        {en:"stream",he:"×œ×©×“×¨ / ×¡×˜×¨×™×",ex:"I stream every night."},
        {en:"channel",he:"×¢×¨×•×¥",ex:"Subscribe to my channel."},
        {en:"upload",he:"×œ×”×¢×œ×•×ª",ex:"I'll upload the photo later."},
        {en:"download",he:"×œ×”×•×¨×™×“",ex:"Download this app now."},
        {en:"battery",he:"×¡×•×œ×œ×”",ex:"My battery is dead."},
        {en:"screen",he:"××¡×š",ex:"My screen cracked."},
        {en:"password",he:"×¡×™×¡××”",ex:"I forgot my password."},
        {en:"username",he:"×©× ××©×ª××©",ex:"What's your username?"},
        {en:"profile",he:"×¤×¨×•×¤×™×œ",ex:"Update your profile."},
        {en:"story",he:"×¡×˜×•×¨×™",ex:"Did you see my story?"},
        {en:"reel",he:"×¨×™×œ",ex:"I made a reel yesterday."},
        {en:"trend",he:"×˜×¨× ×“",ex:"This is the new trend."},
        {en:"viral",he:"×•×™×¨××œ×™",ex:"This video went viral!"},
        {en:"famous",he:"××¤×•×¨×¡×",ex:"She's so famous now."},
        {en:"talent",he:"×›×™×©×¨×•×Ÿ",ex:"She has real talent."},
        {en:"concert",he:"×§×•× ×¦×¨×˜",ex:"I'm going to a concert."},
        {en:"movie",he:"×¡×¨×˜",ex:"Let's watch a movie."},
        {en:"episode",he:"×¤×¨×§",ex:"The new episode is out!"},
        {en:"series",he:"×¡×“×¨×”",ex:"What series are you watching?"},
        {en:"season",he:"×¢×•× ×”",ex:"When does the new season start?"},
        {en:"ticket",he:"×›×¨×˜×™×¡",ex:"I bought two tickets."},
        {en:"stage",he:"×‘××”",ex:"She walked on stage."},
        {en:"band",he:"×œ×”×§×”",ex:"That band is amazing."},
        {en:"artist",he:"×××Ÿ",ex:"He's a real artist."},
        {en:"fan",he:"××¢×¨×™×¥",ex:"I'm a huge fan."},
        {en:"review",he:"×‘×™×§×•×¨×ª",ex:"The review was great."},
        {en:"recommend",he:"×œ×”××œ×™×¥",ex:"I recommend this show."},
        {en:"rating",he:"×“×™×¨×•×’",ex:"What's the rating?"},
        {en:"competition",he:"×ª×—×¨×•×ª",ex:"I joined the competition."},
        {en:"win",he:"×œ× ×¦×—",ex:"I want to win."},
        {en:"lose",he:"×œ×”×¤×¡×™×“",ex:"Nobody likes to lose."},
        {en:"score",he:"×ª×•×¦××” / × ×™×§×•×“",ex:"What's the score?"},
        {en:"team",he:"×§×‘×•×¦×”",ex:"Which team do you support?"},
        {en:"player",he:"×©×—×§×Ÿ",ex:"He's the best player."},
        {en:"coach",he:"××××Ÿ",ex:"The coach is strict."},
        {en:"match",he:"××©×—×§ / ×ª×—×¨×•×ª",ex:"The match starts at 8."},
        {en:"goal",he:"×©×¢×¨ / ××˜×¨×”",ex:"What a great goal!"},
        {en:"champion",he:"××œ×•×£",ex:"He is the champion."},
        {en:"energy",he:"×× ×¨×’×™×”",ex:"I have no energy."},
        {en:"creative",he:"×™×¦×™×¨×ª×™",ex:"She's very creative."},
        {en:"original",he:"××§×•×¨×™",ex:"That's an original idea."},
        {en:"boring",he:"××©×¢××",ex:"This game is boring."},
        {en:"challenge",he:"××ª×’×¨",ex:"I love a good challenge."},
        {en:"practice",he:"×ª×¨×’×•×œ",ex:"Practice makes perfect."},
        {en:"improve",he:"×œ×”×©×ª×¤×¨",ex:"I want to improve."},
        {en:"mistake",he:"×˜×¢×•×ª",ex:"Learn from your mistakes."},
        {en:"lucky",he:"×‘×¨-××–×œ",ex:"You're so lucky!"},
        {en:"chance",he:"×¡×™×›×•×™ / ×”×–×“×× ×•×ª",ex:"Give me a chance."},
      ]
    ]
  },
  2: {
    packs: [
      [
        {en:"ambition",he:"×©××¤×ª× ×•×ª",ex:"She has great ambition."},
        {en:"confident",he:"×‘×˜×•×— ×‘×¢×¦××•",ex:"Be more confident!"},
        {en:"determined",he:"× ×—×•×©",ex:"She's determined to succeed."},
        {en:"responsible",he:"××—×¨××™",ex:"Be responsible for your actions."},
        {en:"independent",he:"×¢×¦×××™",ex:"I want to be independent."},
        {en:"generous",he:"× ×“×™×‘",ex:"He's so generous."},
        {en:"patient",he:"×¡×‘×œ× ×™",ex:"Please be patient."},
        {en:"creative",he:"×™×¦×™×¨×ª×™",ex:"Think creative!"},
        {en:"flexible",he:"×’××™×©",ex:"You need to be flexible."},
        {en:"organized",he:"××¡×•×“×¨",ex:"She's very organized."},
        {en:"deadline",he:"×“×“×œ×™×™×Ÿ",ex:"The deadline is tomorrow."},
        {en:"priority",he:"×¢×“×™×¤×•×ª",ex:"Make it a priority."},
        {en:"opportunity",he:"×”×–×“×× ×•×ª",ex:"Don't miss this opportunity."},
        {en:"experience",he:"× ×™×¡×™×•×Ÿ",ex:"I have no experience."},
        {en:"achieve",he:"×œ×”×©×™×’",ex:"What do you want to achieve?"},
        {en:"succeed",he:"×œ×”×¦×œ×™×—",ex:"Work hard to succeed."},
        {en:"fail",he:"×œ×”×™×›×©×œ",ex:"It's okay to fail."},
        {en:"effort",he:"××××¥",ex:"Put in the effort."},
        {en:"prepare",he:"×œ×”×ª×›×•× ×Ÿ",ex:"Prepare for the exam."},
        {en:"schedule",he:"×œ×•×— ×–×× ×™×",ex:"Check the schedule."},
        {en:"solution",he:"×¤×ª×¨×•×Ÿ",ex:"Find a solution."},
        {en:"problem",he:"×‘×¢×™×”",ex:"We have a problem."},
        {en:"decision",he:"×”×—×œ×˜×”",ex:"Make the right decision."},
        {en:"choice",he:"×‘×—×™×¨×”",ex:"It's your choice."},
        {en:"situation",he:"××¦×‘",ex:"This is a tough situation."},
        {en:"opinion",he:"×“×¢×”",ex:"What's your opinion?"},
        {en:"discuss",he:"×œ×“×•×Ÿ",ex:"Let's discuss this later."},
        {en:"debate",he:"×•×™×›×•×—",ex:"We had a debate."},
        {en:"suggest",he:"×œ×”×¦×™×¢",ex:"Can I suggest something?"},
        {en:"consider",he:"×œ×©×§×•×œ",ex:"Please consider this."},
        {en:"avoid",he:"×œ×”×™×× ×¢",ex:"Avoid junk food."},
        {en:"replace",he:"×œ×”×—×œ×™×£",ex:"Replace bad habits."},
        {en:"create",he:"×œ×™×¦×•×¨",ex:"Create something new."},
        {en:"design",he:"×œ×¢×¦×‘",ex:"I want to design apps."},
        {en:"develop",he:"×œ×¤×ª×—",ex:"Develop your skills."},
        {en:"manage",he:"×œ× ×”×œ",ex:"Can you manage this?"},
        {en:"handle",he:"×œ×”×ª××•×“×“",ex:"I can handle it."},
        {en:"focus",he:"×œ×”×ª××§×“",ex:"Focus on your goals."},
        {en:"distract",he:"×œ×”×¡×™×— ×“×¢×ª",ex:"Stop distracting me!"},
        {en:"attitude",he:"×’×™×©×”",ex:"Your attitude matters."},
        {en:"behavior",he:"×”×ª× ×”×’×•×ª",ex:"Watch your behavior."},
        {en:"influence",he:"×”×©×¤×¢×”",ex:"Music has a big influence."},
        {en:"inspire",he:"×œ×”×©×¤×™×œ",ex:"She inspires everyone."},
        {en:"motivate",he:"×œ×¢×•×“×“",ex:"What motivates you?"},
        {en:"encourage",he:"×œ×¢×•×“×“",ex:"I encourage you to try."},
        {en:"reward",he:"×¤×¨×¡",ex:"Hard work has rewards."},
        {en:"punish",he:"×œ×”×¢× ×™×©",ex:"Don't punish yourself."},
        {en:"balance",he:"××™×–×•×Ÿ",ex:"Find a healthy balance."},
        {en:"routine",he:"×©×’×¨×”",ex:"Build a healthy routine."},
        {en:"habit",he:"×”×¨×’×œ",ex:"Good habits change your life."},
      ]
    ]
  },
  3: {
    packs: [
      [
        {en:"acknowledge",he:"×œ×”×›×™×¨ ×‘×›×š",ex:"Acknowledge your mistakes."},
        {en:"anticipate",he:"×œ×¦×¤×•×ª",ex:"Anticipate what comes next."},
        {en:"collaborate",he:"×œ×©×ª×£ ×¤×¢×•×œ×”",ex:"We need to collaborate."},
        {en:"commit",he:"×œ×”×ª×—×™×™×‘",ex:"Commit to your goals."},
        {en:"communicate",he:"×œ×ª×§×©×¨",ex:"Communicate clearly."},
        {en:"consequence",he:"×ª×•×¦××”",ex:"Think about the consequences."},
        {en:"controversial",he:"×©× ×•×™ ×‘××—×œ×•×§×ª",ex:"That's a controversial topic."},
        {en:"criticism",he:"×‘×™×§×•×¨×ª",ex:"Accept criticism gracefully."},
        {en:"diversity",he:"×’×™×•×•×Ÿ",ex:"We celebrate diversity."},
        {en:"empathy",he:"×××¤×ª×™×”",ex:"Show more empathy."},
        {en:"essential",he:"×—×™×•× ×™",ex:"Sleep is essential."},
        {en:"evaluate",he:"×œ×”×¢×¨×™×š",ex:"Evaluate your progress."},
        {en:"evidence",he:"×¢×“×•×ª / ×¨××™×”",ex:"Show me the evidence."},
        {en:"exception",he:"×™×•×¦× ×“×•×¤×Ÿ",ex:"You're the exception."},
        {en:"expectation",he:"×¦×™×¤×™×™×”",ex:"Manage your expectations."},
        {en:"fundamental",he:"×‘×¡×™×¡×™",ex:"That's a fundamental rule."},
        {en:"generation",he:"×“×•×¨",ex:"Our generation is unique."},
        {en:"impact",he:"×”×©×¤×¢×”",ex:"Make a real impact."},
        {en:"improve",he:"×œ×©×¤×¨",ex:"Always try to improve."},
        {en:"interpret",he:"×œ×¤×¨×©",ex:"How do you interpret this?"},
        {en:"investigate",he:"×œ×—×§×•×¨",ex:"Let's investigate."},
        {en:"maintain",he:"×œ×©××•×¨",ex:"Maintain a healthy diet."},
        {en:"negotiate",he:"×œ× ×”×œ ××©× ×•××ª×Ÿ",ex:"Learn to negotiate."},
        {en:"objective",he:"××˜×¨×”",ex:"What's your objective?"},
        {en:"obstacle",he:"××›×©×•×œ",ex:"Face every obstacle."},
        {en:"perceive",he:"×œ×ª×¤×•×¡",ex:"How do you perceive this?"},
        {en:"perspective",he:"× ×§×•×“×ª ××‘×˜",ex:"See it from my perspective."},
        {en:"phenomenon",he:"×ª×•×¤×¢×”",ex:"It's a global phenomenon."},
        {en:"potential",he:"×¤×•×˜× ×¦×™××œ",ex:"You have so much potential."},
        {en:"prejudice",he:"×“×¢×” ×§×“×•××”",ex:"Fight prejudice."},
        {en:"rational",he:"×¨×¦×™×•× ×œ×™",ex:"Be rational."},
        {en:"recognize",he:"×œ×–×”×•×ª",ex:"I didn't recognize you!"},
        {en:"resilience",he:"×—×•×¡×Ÿ",ex:"Build your resilience."},
        {en:"significant",he:"××©××¢×•×ª×™",ex:"A significant change."},
        {en:"strategy",he:"××¡×˜×¨×˜×’×™×”",ex:"What's your strategy?"},
        {en:"sustainable",he:"×‘×¨-×§×™×™××",ex:"Sustainable living matters."},
        {en:"tolerate",he:"×œ×¡×‘×•×œ",ex:"I can't tolerate this."},
        {en:"vulnerable",he:"×¤×’×™×¢",ex:"It's okay to be vulnerable."},
        {en:"analyze",he:"×œ× ×ª×—",ex:"Analyze the data."},
        {en:"contrast",he:"× ×™×’×•×“",ex:"In contrast, I think..."},
        {en:"convince",he:"×œ×©×›× ×¢",ex:"Try to convince me."},
        {en:"ethical",he:"××ª×™",ex:"Is it ethical?"},
        {en:"imply",he:"×œ×¨××•×–",ex:"What are you implying?"},
        {en:"relevant",he:"×¨×œ×•×•× ×˜×™",ex:"Is this relevant?"},
        {en:"valid",he:"×ª×§×£",ex:"That's a valid point."},
        {en:"complex",he:"××•×¨×›×‘",ex:"It's more complex than that."},
        {en:"ambiguous",he:"×“×•-××©××¢×™",ex:"That answer is ambiguous."},
        {en:"bias",he:"×”×˜×™×”",ex:"Avoid confirmation bias."},
        {en:"insight",he:"×ª×•×‘× ×”",ex:"She shared a great insight."},
        {en:"assumption",he:"×”× ×—×”",ex:"Don't make assumptions."},
      ]
    ]
  },
  4: {
    packs: [
      [
        {en:"accountability",he:"××—×¨×™×•×ª×™×•×ª",ex:"Take accountability."},
        {en:"adversity",he:"××¦×•×§×”",ex:"Overcome adversity."},
        {en:"articulate",he:"×œ×‘×˜× ×‘×‘×™×¨×•×¨",ex:"Articulate your thoughts."},
        {en:"authenticity",he:"××•×ª× ×˜×™×•×ª",ex:"Be true to your authenticity."},
        {en:"breadth",he:"×¨×•×—×‘",ex:"The breadth of knowledge."},
        {en:"catalyst",he:"×–×¨×–",ex:"She was the catalyst for change."},
        {en:"coherent",he:"×§×•×”×¨× ×˜×™",ex:"Give a coherent argument."},
        {en:"concise",he:"×ª××¦×™×ª×™",ex:"Be concise in your writing."},
        {en:"connotation",he:"×§×•× ×•×˜×¦×™×”",ex:"Words carry connotations."},
        {en:"cumulative",he:"××¦×˜×‘×¨",ex:"The cumulative effect is huge."},
        {en:"discern",he:"×œ×”×‘×—×™×Ÿ",ex:"Discern fact from fiction."},
        {en:"eloquent",he:"×¨×”×•×˜",ex:"An eloquent speaker."},
        {en:"encompass",he:"×œ×›×œ×•×œ",ex:"The course encompasses many topics."},
        {en:"hierarchy",he:"×”×™×¨×¨×›×™×”",ex:"The social hierarchy matters."},
        {en:"hypothetical",he:"×”×™×¤×•×ª×˜×™",ex:"A hypothetical scenario."},
        {en:"implicit",he:"××¨×•××–",ex:"The implicit meaning."},
        {en:"integrity",he:"×™×•×©×¨×”",ex:"Act with integrity."},
        {en:"intrinsic",he:"×¤× ×™××™/××”×•×ª×™",ex:"Intrinsic motivation."},
        {en:"leverage",he:"××™× ×•×£",ex:"Leverage your strengths."},
        {en:"mitigate",he:"×œ×”×¤×—×™×ª",ex:"Mitigate the risks."},
        {en:"nuance",he:"× ×™×•×× ×¡",ex:"Understand the nuance."},
        {en:"paradigm",he:"×¤×¨×“×™×’××”",ex:"A paradigm shift."},
        {en:"precedent",he:"×ª×§×“×™×",ex:"Set a precedent."},
        {en:"profound",he:"×¢××•×§",ex:"A profound statement."},
        {en:"reinforce",he:"×œ×—×–×§",ex:"Reinforce good habits."},
        {en:"rhetoric",he:"×¨×˜×•×¨×™×§×”",ex:"Political rhetoric."},
        {en:"scrutinize",he:"×œ×‘×—×•×Ÿ ×œ×¢×•××§",ex:"Scrutinize every detail."},
        {en:"subjective",he:"×¡×•×‘×™×™×§×˜×™×‘×™",ex:"Beauty is subjective."},
        {en:"synthesize",he:"×œ×¡× ×ª×–",ex:"Synthesize the information."},
        {en:"tangible",he:"××•×—×©×™",ex:"Tangible results."},
        {en:"tenacious",he:"×¢×§×©×Ÿ/×¢×™×§×©",ex:"She is tenacious."},
        {en:"threshold",he:"×¡×£",ex:"At the threshold of change."},
        {en:"transcend",he:"×œ×¢×œ×•×ª ××¢×œ",ex:"Transcend your limits."},
        {en:"unprecedented",he:"×—×¡×¨ ×ª×§×“×™×",ex:"An unprecedented event."},
        {en:"versatile",he:"×¨×‘-×ª×›×œ×™×ª×™",ex:"A versatile tool."},
        {en:"advocate",he:"×œ×ª××•×š/×¡× ×’×•×¨",ex:"Advocate for change."},
        {en:"alienate",he:"×œ×”×¨×—×™×§",ex:"Don't alienate your friends."},
        {en:"captivate",he:"×œ×¨×ª×§",ex:"The story captivated me."},
        {en:"contradict",he:"×œ×¡×ª×•×¨",ex:"You contradict yourself."},
        {en:"elaborate",he:"×œ×¤×¨×˜",ex:"Can you elaborate?"},
        {en:"empower",he:"×œ×”×¢×¦×™×",ex:"Empower others."},
        {en:"exaggerate",he:"×œ×”×’×–×™×",ex:"Don't exaggerate."},
        {en:"facilitate",he:"×œ××¤×©×¨",ex:"Facilitate better learning."},
        {en:"illuminate",he:"×œ×”××™×¨",ex:"Illuminate the problem."},
        {en:"infer",he:"×œ×”×¡×™×§",ex:"What can you infer?"},
        {en:"manifest",he:"×œ×”×ª×‘×˜×/×œ×××©",ex:"Manifest your destiny."},
        {en:"stimulate",he:"×œ×’×¨×•×ª",ex:"Stimulate your mind."},
        {en:"suppress",he:"×œ×“×›×",ex:"Don't suppress emotions."},
        {en:"undermine",he:"×œ×¢×¨×¢×¨",ex:"Don't undermine others."},
        {en:"assert",he:"×œ×§×‘×•×¢/×œ×˜×¢×•×Ÿ",ex:"Assert your rights."},
      ]
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  currentLevel: 1,
  totalScore: 0,
  currentStreak: 0,
  bestStreak: 0,
  gamesPlayed: 0,
  unlockedPacks: { 1: 1, 2: 1, 3: 1, 4: 1 },
  bestScores: { mc: 0, flash: 0 },
  history: [],
  customPacks: [],        // [{id, name, words:[{en,he,ex}]}]
  activeSources: ['builtin'] // 'builtin' | 'custom_xxx'
};

function loadState() {
  const saved = localStorage.getItem('wordup_state');
  if (saved) {
    const parsed = JSON.parse(saved);
    // migrate old selectedPacks system
    if (parsed.selectedPacks && !parsed.activeSources) {
      parsed.activeSources = ['builtin', ...(parsed.selectedPacks || [])];
    }
    state = { ...state, ...parsed };
  }
  if (!state.activeSources || !state.activeSources.length) state.activeSources = ['builtin'];
  updateUI();
  updateNicknameUI();
  updateSourcesUI();
  selectLevelDrop(state.currentLevel);
  history.replaceState({ screen: 'home' }, '');
  if (!state.nickname) openNicknameModal();
}
function saveState() {
  localStorage.setItem('wordup_state', JSON.stringify(state));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAvailableWords(level) {
  const sources = state.activeSources || ['builtin'];
  let words = [];
  if (sources.includes('builtin')) {
    for (let l = 1; l <= level; l++) {
      if (!WORDS[l]) continue;
      const packs = WORDS[l].packs;
      const unlocked = state.unlockedPacks[l] || 1;
      for (let p = 0; p < Math.min(unlocked, packs.length); p++) {
        words = words.concat(packs[p]);
      }
    }
  }
  (state.customPacks || []).forEach(pack => {
    if (sources.includes(pack.id)) {
      words = words.concat(pack.words);
    }
  });
  return words;
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function getWrongOptions(allWords, correct, count, reversed) {
  const pool = allWords.filter(w => w.en !== correct.en);
  return shuffle(pool).slice(0, count).map(w => reversed ? w.he : w.en);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Track active game and paused state
let activeGame = null; // 'mc' | 'flash' | 'fill' | 'match'
let gamePaused = { mc: false, flash: false, fill: false, match: false };

function confirmLeaveGame(type) {
  // if game is done (showing results) or not started yet â€” leave freely
  const gameEl = document.getElementById(type + '-game');
  const resultsEl = document.getElementById(type + '-results');
  if (!gameEl || gameEl.style.display === 'none' || (resultsEl && resultsEl.style.display !== 'none')) {
    goHome(); return;
  }
  if (confirm('×œ×¦××ª ××”××©×—×§?\n×”×”×ª×§×“××•×ª ×ª×™×©××¨ â€” ×ª×•×›×œ ×œ×”××©×™×š ××—×¨ ×›×š.')) {
    if (type === 'run') {
      cancelAnimationFrame(rn.animFrame);
      rn.paused = true;
      gamePaused['run'] = true;
    } else {
      if (type === 'listen' || type === 'colors' || type === 'emoji') window.speechSynthesis.cancel();
      gamePaused[type] = true;
    }
    goHome();
  }
}

function confirmRestart(type) {
  if (confirm('×œ×”×ª×—×™×œ ××—×“×©?\n×”×ª×§×“××•×ª ×”××©×—×§ ×”× ×•×›×—×™ ×ª××‘×“.')) {
    gamePaused[type] = false;
    if (type === 'run') cancelAnimationFrame(rn.animFrame);
    if (type === 'listen' || type === 'colors' || type === 'emoji') window.speechSynthesis.cancel();
    if (type === 'mc') initMC(mc.reversed);
    if (type === 'flash') initFlash(fl.reversed);
    if (type === 'fill') initFill();
    if (type === 'match') initMatch();
    if (type === 'run') initRun();
    if (type === 'listen') initListen();
    if (type === 'colors') initColors();
    if (type === 'emoji') startEmojiGame();
  }
}

function confirmResetHistory() {
  if (confirm('×œ××¤×¡ ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×”?\n× ×™×§×•×“, ×¨×¦×¤×™× ×•××©×—×§×™× ×™×™××—×§×• ×œ×¦××™×ª×•×ª.')) {
    state.totalScore = 0;
    state.currentStreak = 0;
    state.bestStreak = 0;
    state.gamesPlayed = 0;
    state.bestScores = {};
    state.history = [];
    saveState();
    updateUI();
    updateStatsScreen();
    showToast('âœ… ×”×™×¡×˜×•×¨×™×” ××•×¤×¡×”');
  }
}

// Words helpers
function getBuiltinWords(level) {
  let words = [];
  for (let l = 1; l <= level; l++) {
    if (!WORDS[l]) continue;
    const packs = WORDS[l].packs;
    const unlocked = state.unlockedPacks[l] || 1;
    for (let p = 0; p < Math.min(unlocked, packs.length); p++) {
      words = words.concat(packs[p]);
    }
  }
  return words;
}

function hasOnlyCustomSources() {
  const sources = state.activeSources || ['builtin'];
  return !sources.includes('builtin') && sources.some(s => s !== 'builtin');
}

function getFillWords(level) {
  // Always use only builtin words for fill game (they have sentences)
  const builtinWords = getBuiltinWords(level);
  return builtinWords.filter(w => w.ex && w.ex.includes(w.en));
}

function showTab(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'stats') updateStatsScreen();
}

function goHome() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-home').classList.add('active');
  document.querySelectorAll('.tab')[0].classList.add('active');
  navigateTo('home');
  updateUI();
}

function selectLevel(lvl, btn) {
  state.currentLevel = lvl;
  document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  updateAddWordsUI();
  saveState();
}

function updateUI() {
  document.getElementById('totalScore').textContent = state.totalScore;
  document.getElementById('streakVal').textContent = state.currentStreak;
  document.getElementById('home-mc-best').textContent = state.bestScores.mc || 0;
  document.getElementById('home-flash-best').textContent = state.bestScores.flash || 0;
  document.getElementById('home-fill-best').textContent = state.bestScores.fill || 0;
  document.getElementById('home-match-best').textContent = state.bestScores.match || 0;
  document.getElementById('home-run-best').textContent = state.bestScores.run || 0;
  document.getElementById('home-listen-best').textContent = state.bestScores.listen || 0;
  document.getElementById('home-colors-best').textContent = state.bestScores.colors || 0;
  document.getElementById('home-emoji-best').textContent = state.bestScores.emoji || 0;

  // Disable fill game card if no builtin words available
  const fillDisabled = getFillWords(state.currentLevel).length < 4;
  const fillCard = document.querySelector('[onclick="startGame(\'fill\')"]');
  if (fillCard) {
    fillCard.style.opacity = fillDisabled ? '0.4' : '1';
    fillCard.style.pointerEvents = fillDisabled ? 'none' : '';
    fillCard.querySelector('.game-desc').textContent = fillDisabled ? '(×“×•×¨×© ××™×œ×™× ××•×‘× ×•×ª)' : '×”×©×œ× ××ª ×”××™×œ×” ×”×—×¡×¨×”';
  }
  updateAddWordsUI();
}

function updateAddWordsUI() {
  const lvl = state.currentLevel;
  const level = WORDS[lvl];
  if (!level) return;
  const totalPacks = level.packs.length;
  const unlocked = state.unlockedPacks[lvl] || 1;
  document.getElementById('addLevelLabel').textContent = lvl;

  const wordsTotal = getAvailableWords(lvl).length;
  document.getElementById('wordsRemaining').textContent = `×¡×”"×› ${wordsTotal} ××™×œ×™× ×–××™× ×•×ª ×‘×¨××” ${lvl} ×•××˜×”`;

  const btn = document.getElementById('addWordsBtn');
  if (unlocked >= totalPacks) {
    btn.textContent = `âœ… ×›×œ ×”××™×œ×™× ×©×œ ×¨××” ${lvl} ×¤×ª×•×—×•×ª!`;
    btn.disabled = true;
    btn.style.opacity = '0.5';
  } else {
    btn.textContent = `â• ×”×•×¡×£ 50 ××™×œ×™× × ×•×¡×¤×•×ª ×œ×¨××” ${lvl}`;
    btn.disabled = false;
    btn.style.opacity = '1';
  }
}

function addWordPack() {
  const lvl = state.currentLevel;
  const totalPacks = WORDS[lvl].packs.length;
  const current = state.unlockedPacks[lvl] || 1;
  if (current < totalPacks) {
    state.unlockedPacks[lvl] = current + 1;
    saveState();
    updateAddWordsUI();
    alert(`ğŸ‰ 50 ××™×œ×™× ×—×“×©×•×ª × ×•×¡×¤×• ×œ×¨××” ${lvl}!`);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(type) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + type).classList.add('active');
  const tabIdx = { mc: 1, flash: 2, fill: 3, match: 4, run: 5, listen: 6, colors: 7, emoji: 8 };
  document.querySelectorAll('.tab')[tabIdx[type]].classList.add('active');
  navigateTo(type);
  activeGame = type;

  // Fill game: disabled when only custom sources
  if (type === 'fill') {
    const fillWords = getFillWords(state.currentLevel);
    if (fillWords.length < 4) {
      alert('××©×—×§ ×”×©×œ××ª ××©×¤×˜ ×“×•×¨×© ××™×œ×™× ××•×‘× ×•×ª.\n×”×¤×¢×œ "××™×œ×™× ××•×‘× ×•×ª" ×‘××§×•×¨×•×ª ×›×“×™ ×œ×©×—×§.');
      goHome(); return;
    }
  }

  // Resume paused game if available
  if (gamePaused[type]) {
    gamePaused[type] = false;
    if (type === 'mc') renderMCQuestion();
    if (type === 'flash') renderFlashCard();
    if (type === 'fill') renderFillQuestion();
    if (type === 'match') { clearInterval(mt.timerInterval); mt.startTime = Date.now() - mt.elapsed * 1000; mt.done = false; mt.timerInterval = setInterval(updateMatchTimer, 500); }
    if (type === 'run') {
      document.getElementById('run-game').style.display = 'block';
      document.getElementById('run-results').style.display = 'none';
      document.getElementById('runPausedOverlay').classList.remove('hidden');
      // show "continue" button instead of paused overlay after 1s
      const overlay = document.getElementById('runPausedOverlay');
      overlay.innerHTML = `
        <div style="font-size:48px">â¸ï¸</div>
        <p style="font-weight:700;font-size:18px">×”××©×š?</p>
        <button class="btn-primary" style="margin-top:12px" onclick="document.getElementById('runPausedOverlay').classList.add('hidden'); spawnRunWord();">â–¶ï¸ ×”××©×š ××©×—×§</button>
      `;
      return;
    }
    if (type === 'listen') {
      document.getElementById('listen-game').style.display = 'block';
      document.getElementById('listen-results').style.display = 'none';
      renderListenRound();
      return;
    }
    if (type === 'colors') {
      document.getElementById('colors-game').style.display = 'block';
      document.getElementById('colors-results').style.display = 'none';
      renderColorsRound();
      return;
    }
    if (type === 'emoji') {
      document.getElementById('emoji-setup').style.display = 'none';
      document.getElementById('emoji-game').style.display = 'block';
      document.getElementById('emoji-results').style.display = 'none';
      renderEmojiRound();
      return;
    }
    document.getElementById(type + '-game').style.display = 'block';
    document.getElementById(type + '-results').style.display = 'none';
    return;
  }

  if (type === 'mc') initMC();
  if (type === 'flash') initFlash();
  if (type === 'fill') initFill();
  if (type === 'match') initMatch();
  if (type === 'run') initRun();
  if (type === 'listen') initListen();
  if (type === 'colors') initColors();
  if (type === 'emoji') { showEmojiSetup(); renderEmojiCatSelector(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTIPLE CHOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mc = {};

function setMCDir(reversed) {
  if (mc.reversed === reversed) return; // no change
  if (mc.idx > 0) {
    const dir = reversed ? '×× ×’×œ×™×ª â† ×¢×‘×¨×™×ª' : '×¢×‘×¨×™×ª â† ×× ×’×œ×™×ª';
    if (!confirm(`×œ×¢×‘×•×¨ ×œ×›×™×•×•×Ÿ "${dir}"?\n×”××©×—×§ ×”× ×•×›×—×™ ×™×ª××¤×¡.`)) return;
  }
  mc.reversed = reversed;
  document.getElementById('mc-dir-he').classList.toggle('active', !reversed);
  document.getElementById('mc-dir-en').classList.toggle('active', reversed);
  initMC(reversed);
}

function initMC(reversed) {
  const allWords = getAvailableWords(state.currentLevel);
  if (allWords.length < 4) { alert('×¦×¨×™×š ×œ×¤×—×•×ª 4 ××™×œ×™×!'); return; }
  mc.words = shuffle(allWords).slice(0, 10);
  mc.all = allWords;
  mc.idx = 0;
  mc.score = 0;
  mc.correct = 0;
  mc.streak = 0;
  mc.bestStreak = 0;
  mc.reversed = reversed || false;

  document.getElementById('mc-game').style.display = 'block';
  document.getElementById('mc-results').style.display = 'none';
  renderMCQuestion();
}

function renderMCQuestion() {
  const word = mc.words[mc.idx];
  const reversed = mc.reversed;
  document.getElementById('mc-progress').textContent = `${mc.idx + 1} / ${mc.words.length}`;
  document.getElementById('mc-bar').style.width = `${((mc.idx + 1) / mc.words.length) * 100}%`;
  document.getElementById('mc-word').textContent = reversed ? word.en : word.he;
  document.getElementById('mc-word').style.direction = reversed ? 'ltr' : 'rtl';
  document.getElementById('mc-example').textContent = '';
  document.getElementById('mc-feedback').className = 'feedback-banner';
  document.getElementById('mc-next').classList.remove('visible');

  const wrongs = getWrongOptions(mc.all, word, 3, reversed);
  const correctOpt = reversed ? word.he : word.en;
  const options = shuffle([correctOpt, ...wrongs]);

  const grid = document.getElementById('mc-options');
  grid.innerHTML = '';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt;
    btn.style.direction = reversed ? 'rtl' : 'ltr';
    btn.onclick = () => checkMC(opt, word, btn);
    grid.appendChild(btn);
  });
}

function checkMC(selected, word, btn) {
  const allBtns = document.querySelectorAll('.option-btn');
  allBtns.forEach(b => b.disabled = true);

  const correctOpt = mc.reversed ? word.he : word.en;
  const isCorrect = selected === correctOpt;
  const fb = document.getElementById('mc-feedback');
  const nextBtn = document.getElementById('mc-next');

  if (isCorrect) {
    btn.classList.add('correct');
    mc.streak++;
    mc.correct++;
    if (mc.streak > mc.bestStreak) mc.bestStreak = mc.streak;
    const multiplier = Math.min(mc.streak, 5);
    const pts = 10 * state.currentLevel * multiplier;
    mc.score += pts;
    state.totalScore += pts;
    state.currentStreak++;
    if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
    fb.className = 'feedback-banner correct';
    fb.innerHTML = `âœ… × ×›×•×Ÿ! +${pts} × ×§×•×“×•×ª${mc.streak > 1 ? ` ğŸ”¥Ã—${multiplier}` : ''}`;
    document.getElementById('mc-example').textContent = word.ex;
    sfxCorrect();
  } else {
    btn.classList.add('wrong');
    allBtns.forEach(b => { if (b.textContent === correctOpt) b.classList.add('correct'); });
    mc.streak = 0;
    state.currentStreak = 0;
    fb.className = 'feedback-banner wrong';
    fb.innerHTML = mc.reversed
      ? `âŒ ×”×™×™×ª×”: <strong>${word.he}</strong>`
      : `âŒ ×”×™×™×ª×”: <strong>${word.en}</strong>`;
    btn.classList.add('shake');
    sfxWrong();
  }

  document.getElementById('streakVal').textContent = state.currentStreak;
  document.getElementById('totalScore').textContent = state.totalScore;
  nextBtn.classList.add('visible');
  nextBtn.textContent = mc.idx < mc.words.length - 1 ? '×”×‘× â†' : '×¡×™×•×!';
}

function mcNext() {
  mc.idx++;
  if (mc.idx >= mc.words.length) {
    endMC();
  } else {
    renderMCQuestion();
  }
}

function endMC() {
  sfxComplete();
  if (mc.score > (state.bestScores.mc || 0)) state.bestScores.mc = mc.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'mc', score: mc.score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸ¯' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('mc-game').style.display = 'none';
  document.getElementById('mc-results').style.display = 'block';
  const pct = Math.round((mc.correct / mc.words.length) * 100);
  document.getElementById('mc-res-icon').textContent = pct >= 80 ? 'ğŸ†' : pct >= 50 ? 'ğŸ‘' : 'ğŸ’ª';
  document.getElementById('mc-res-title').textContent = pct >= 80 ? '×›×œ ×”×›×‘×•×“!' : pct >= 50 ? '×™×¤×”!' : '×”××©×š ×œ×ª×¨×’×œ!';
  document.getElementById('mc-res-score').textContent = mc.score;
  document.getElementById('mc-res-correct').textContent = `${mc.correct}/${mc.words.length}`;
  document.getElementById('mc-res-streak').textContent = mc.bestStreak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLASHCARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fl = {};

function setFlDir(reversed) {
  if (fl.reversed === reversed) return; // no change
  if (fl.idx > 0) {
    const dir = reversed ? '×× ×’×œ×™×ª â† ×¢×‘×¨×™×ª' : '×¢×‘×¨×™×ª â† ×× ×’×œ×™×ª';
    if (!confirm(`×œ×¢×‘×•×¨ ×œ×›×™×•×•×Ÿ "${dir}"?\n×”××©×—×§ ×”× ×•×›×—×™ ×™×ª××¤×¡.`)) return;
  }
  fl.reversed = reversed;
  document.getElementById('fl-dir-he').classList.toggle('active', !reversed);
  document.getElementById('fl-dir-en').classList.toggle('active', reversed);
  initFlash(reversed);
}

function initFlash(reversed) {
  const allWords = getAvailableWords(state.currentLevel);
  fl.words = shuffle(allWords).slice(0, 15);
  fl.idx = 0;
  fl.score = 0;
  fl.knew = 0;
  fl.flipped = false;
  fl.reversed = reversed || false;

  document.getElementById('flash-game').style.display = 'block';
  document.getElementById('flash-results').style.display = 'none';
  renderFlashCard();
}

function renderFlashCard() {
  fl.flipped = false;
  const card = document.getElementById('flashcard');
  card.classList.remove('flipped');
  document.getElementById('flash-progress').textContent = `${fl.idx + 1} / ${fl.words.length}`;
  document.getElementById('flash-bar').style.width = `${((fl.idx + 1) / fl.words.length) * 100}%`;
  const word = fl.words[fl.idx];
  const front = fl.reversed ? word.en : word.he;
  const back = fl.reversed ? word.he : word.en;
  document.getElementById('flash-word').textContent = front;
  document.getElementById('flash-word').style.direction = fl.reversed ? 'ltr' : 'rtl';
  document.getElementById('flash-answer').textContent = back;
  document.getElementById('flash-answer').style.direction = fl.reversed ? 'rtl' : 'ltr';
  document.getElementById('flash-example').textContent = word.ex;
  document.getElementById('flash-didnt').classList.remove('visible');
  document.getElementById('flash-knew').classList.remove('visible');
}

function flipCard() {
  if (fl.flipped) return;
  fl.flipped = true;
  document.getElementById('flashcard').classList.add('flipped');
  setTimeout(() => {
    document.getElementById('flash-didnt').classList.add('visible');
    document.getElementById('flash-knew').classList.add('visible');
  }, 300);
}

function flashAnswer(knew) {
  if (knew) {
    fl.knew++;
    const pts = 8 * state.currentLevel;
    fl.score += pts;
    state.totalScore += pts;
    state.currentStreak++;
    sfxCorrect();
  } else {
    state.currentStreak = 0;
    sfxWrong();
  }
  document.getElementById('streakVal').textContent = state.currentStreak;
  document.getElementById('totalScore').textContent = state.totalScore;
  fl.idx++;
  if (fl.idx >= fl.words.length) endFlash();
  else renderFlashCard();
}

function endFlash() {
  sfxComplete();
  if (fl.score > (state.bestScores.flash || 0)) state.bestScores.flash = fl.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'flash', score: fl.score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸƒ' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('flash-game').style.display = 'none';
  document.getElementById('flash-results').style.display = 'block';
  const pct = Math.round((fl.knew / fl.words.length) * 100);
  document.getElementById('flash-res-title').textContent = pct >= 80 ? '××“×”×™×! ğŸŒŸ' : pct >= 50 ? '×™×¤×”! ğŸ‘' : '×”××©×š ×œ×ª×¨×’×œ! ğŸ’ª';
  document.getElementById('flash-res-score').textContent = fl.score;
  document.getElementById('flash-res-knew').textContent = `${fl.knew}/${fl.words.length}`;
  document.getElementById('flash-res-pct').textContent = pct + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatsScreen() {
  document.getElementById('stat-total').textContent = state.totalScore;
  document.getElementById('stat-streak').textContent = state.bestStreak;
  document.getElementById('stat-games').textContent = state.gamesPlayed;
  document.getElementById('stat-level').textContent = state.currentLevel;

  const list = document.getElementById('historyList');
  if (state.history.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="e-icon">ğŸ®</div><p>×¢×“×™×™×Ÿ ××™×Ÿ ××©×—×§×™×.<br>×©×—×§ ××ª ×”××©×—×§ ×”×¨××©×•×Ÿ ×©×œ×š!</p></div>';
    return;
  }
  list.innerHTML = state.history.map(h => `
    <div class="history-item">
      <div class="hi-left">
        <span class="hi-icon">${h.icon}</span>
        <div>
          <div class="hi-name">${h.type === 'mc' ? '××•×œ×˜×™-×¦\'×•×™×¡' : h.type === 'fill' ? '×”×©×œ××ª ××©×¤×˜' : h.type === 'match' ? '×”×ª×××”' : h.type === 'run' ? 'Word Run' : h.type === 'listen' ? '×”××–× ×”' : h.type === 'colors' ? '×¦×‘×¢×™×' : h.type === 'emoji' ? '×ª××•× ×•×ª' : '×¤×œ××©×§××¨×“×¡'}</div>
          <div class="hi-date">${h.date}</div>
        </div>
      </div>
      <span class="hi-score">${h.score}</span>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILL IN THE BLANK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fi = {};

function initFill() {
  const valid = getFillWords(state.currentLevel);
  if (valid.length < 4) { alert('××™×Ÿ ××¡×¤×™×§ ××™×œ×™× ××•×‘× ×•×ª ×¢× ××©×¤×˜×™×!'); return; }
  fi.words = shuffle(valid).slice(0, 10);
  fi.all = valid; // always use builtin pool for wrong options
  fi.idx = 0;
  fi.score = 0;
  fi.correct = 0;
  fi.streak = 0;
  fi.bestStreak = 0;

  document.getElementById('fill-game').style.display = 'block';
  document.getElementById('fill-results').style.display = 'none';
  renderFillQuestion();
}

function renderFillQuestion() {
  const word = fi.words[fi.idx];
  document.getElementById('fill-progress').textContent = `${fi.idx + 1} / ${fi.words.length}`;
  document.getElementById('fill-bar').style.width = `${((fi.idx + 1) / fi.words.length) * 100}%`;
  document.getElementById('fill-feedback').className = 'feedback-banner';
  document.getElementById('fill-next').classList.remove('visible');
  document.getElementById('fill-translation').textContent = '';
  document.getElementById('fill-translation').className = 'translation-flash';

  // Build sentence with blank
  const sentence = word.ex.replace(word.en, '<span class="sentence-blank" id="fill-blank">_ _ _</span>');
  document.getElementById('fill-sentence').innerHTML = sentence;

  // Build options
  const wrongs = getWrongOptions(fi.all, word, 3, false);
  const options = shuffle([word.en, ...wrongs]);
  const grid = document.getElementById('fill-options');
  grid.innerHTML = '';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt;
    btn.style.direction = 'ltr';
    btn.onclick = () => checkFill(opt, word, btn);
    grid.appendChild(btn);
  });
}

function checkFill(selected, word, btn) {
  const allBtns = document.querySelectorAll('#fill-options .option-btn');
  allBtns.forEach(b => b.disabled = true);

  const isCorrect = selected === word.en;
  const fb = document.getElementById('fill-feedback');
  const nextBtn = document.getElementById('fill-next');
  const blank = document.getElementById('fill-blank');
  const trans = document.getElementById('fill-translation');

  if (isCorrect) {
    btn.classList.add('correct');
    if (blank) { blank.textContent = word.en; blank.classList.add('revealed'); }
    fi.streak++;
    fi.correct++;
    if (fi.streak > fi.bestStreak) fi.bestStreak = fi.streak;
    const multiplier = Math.min(fi.streak, 5);
    const pts = 12 * state.currentLevel * multiplier;
    fi.score += pts;
    state.totalScore += pts;
    state.currentStreak++;
    if (state.currentStreak > state.bestStreak) state.bestStreak = state.currentStreak;
    fb.className = 'feedback-banner correct';
    fb.innerHTML = `âœ… × ×›×•×Ÿ! +${pts} × ×§×•×“×•×ª${fi.streak > 1 ? ` ğŸ”¥Ã—${multiplier}` : ''}`;
    sfxCorrect();
    trans.textContent = `"${word.en}" = ${word.he}`;
    trans.className = 'translation-flash show';
    document.getElementById('streakVal').textContent = state.currentStreak;
    document.getElementById('totalScore').textContent = state.totalScore;
    setTimeout(() => fillNext(), 1800);
  } else {
    btn.classList.add('wrong');
    allBtns.forEach(b => { if (b.textContent === word.en) b.classList.add('correct'); });
    if (blank) { blank.textContent = word.en; blank.classList.add('revealed'); }
    fi.streak = 0;
    state.currentStreak = 0;
    fb.className = 'feedback-banner wrong';
    fb.innerHTML = `âŒ ×”×™×™×ª×”: <strong>${word.en}</strong> = ${word.he}`;
    sfxWrong();
    document.getElementById('streakVal').textContent = state.currentStreak;
    document.getElementById('totalScore').textContent = state.totalScore;
    nextBtn.classList.add('visible');
    nextBtn.textContent = fi.idx < fi.words.length - 1 ? '×”×‘× â†' : '×¡×™×•×!';
  }
}

function fillNext() {
  fi.idx++;
  if (fi.idx >= fi.words.length) endFill();
  else renderFillQuestion();
}

function endFill() {
  sfxComplete();
  if (fi.score > (state.bestScores.fill || 0)) state.bestScores.fill = fi.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'fill', score: fi.score, date: new Date().toLocaleDateString('he-IL'), icon: 'âœï¸' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('fill-game').style.display = 'none';
  document.getElementById('fill-results').style.display = 'block';
  const pct = Math.round((fi.correct / fi.words.length) * 100);
  document.getElementById('fill-res-icon').textContent = pct >= 80 ? 'ğŸ†' : pct >= 50 ? 'ğŸ‘' : 'ğŸ’ª';
  document.getElementById('fill-res-title').textContent = pct >= 80 ? '×›×œ ×”×›×‘×•×“!' : pct >= 50 ? '×™×¤×”!' : '×”××©×š ×œ×ª×¨×’×œ!';
  document.getElementById('fill-res-score').textContent = fi.score;
  document.getElementById('fill-res-correct').textContent = `${fi.correct}/${fi.words.length}`;
  document.getElementById('fill-res-streak').textContent = fi.bestStreak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD RUN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rn = {};

const RUN_SPEEDS = [
  { label: 1, duration: 6000 },   // level 1 â€” slow
  { label: 2, duration: 4800 },
  { label: 3, duration: 3600 },
  { label: 4, duration: 2600 },
  { label: 5, duration: 1800 },   // level 5 â€” brutal
];

function initRun() {
  const allWords = getAvailableWords(state.currentLevel);
  if (allWords.length < 4) { alert('×¦×¨×™×š ×œ×¤×—×•×ª 4 ××™×œ×™×!'); return; }

  rn.words = shuffle([...allWords]);
  rn.all = allWords;
  rn.idx = 0;
  rn.score = 0;
  rn.lives = 3;
  rn.streak = 0;
  rn.bestStreak = 0;
  rn.speedLevel = 0;
  rn.wordsAnswered = 0;
  rn.paused = false;
  rn.animFrame = null;
  rn.wordEl = null;
  rn.falling = false;
  rn.answered = false;

  document.getElementById('run-game').style.display = 'block';
  document.getElementById('run-results').style.display = 'none';
  document.getElementById('runPausedOverlay').classList.add('hidden');

  updateRunHUD();
  startCountdown(() => spawnRunWord());
}

function resumeRun() {
  document.getElementById('run-game').style.display = 'block';
  document.getElementById('run-results').style.display = 'none';
  document.getElementById('runPausedOverlay').classList.remove('hidden');
  // word will be re-spawned when user clicks play again
}

function startCountdown(cb) {
  const el = document.getElementById('runCountdown');
  el.classList.remove('hidden');
  let count = 3;
  el.textContent = count;
  const iv = setInterval(() => {
    count--;
    if (count === 0) {
      el.textContent = 'GO!';
      setTimeout(() => {
        el.classList.add('hidden');
        el.textContent = '';
        cb();
      }, 600);
      clearInterval(iv);
    } else {
      el.textContent = count;
      el.style.animation = 'none';
      void el.offsetHeight;
      el.style.animation = 'pop 0.4s ease';
    }
  }, 700);
}

function spawnRunWord() {
  if (rn.lives <= 0) return;
  if (rn.idx >= rn.words.length) {
    rn.words = shuffle([...rn.all]);
    rn.idx = 0;
  }

  const word = rn.words[rn.idx];
  rn.currentWord = word;
  rn.answered = false;
  rn.falling = true;

  const arena = document.getElementById('runArena');

  // Remove old bubble
  const old = arena.querySelector('.run-word-bubble');
  if (old) old.remove();

  // Create bubble
  const bubble = document.createElement('div');
  bubble.className = 'run-word-bubble';
  bubble.textContent = word.he;
  bubble.style.top = '-60px';
  arena.appendChild(bubble);
  rn.wordEl = bubble;

  // Build answer options
  buildRunOptions(word);

  // Start falling animation
  const arenaH = arena.clientHeight;
  const duration = RUN_SPEEDS[rn.speedLevel].duration;
  const start = performance.now();
  const startTop = -60;
  const endTop = arenaH + 10;

  function animate(now) {
    if (rn.answered || rn.lives <= 0) return;
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);
    const top = startTop + (endTop - startTop) * progress;
    bubble.style.top = top + 'px';

    // Danger zone coloring
    const pct = top / arenaH;
    if (pct > 0.75) {
      bubble.style.background = `hsl(${Math.round((1 - pct) * 120)}, 80%, 50%)`;
      bubble.style.boxShadow = `0 4px 20px hsla(${Math.round((1 - pct) * 120)}, 80%, 50%, 0.5)`;
    } else {
      bubble.style.background = '';
      bubble.style.boxShadow = '';
    }

    if (progress < 1) {
      rn.animFrame = requestAnimationFrame(animate);
    } else {
      // Word escaped â€” lose a life
      wordEscaped();
    }
  }
  rn.animFrame = requestAnimationFrame(animate);
}

function buildRunOptions(word) {
  const wrongs = shuffle(rn.all.filter(w => w.en !== word.en)).slice(0, 3).map(w => w.en);
  const options = shuffle([word.en, ...wrongs]);
  const grid = document.getElementById('runOptions');
  grid.innerHTML = '';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'run-option';
    btn.textContent = opt;
    btn.onclick = () => handleRunAnswer(opt, word, btn);
    grid.appendChild(btn);
  });
}

function handleRunAnswer(chosen, word, btn) {
  if (rn.answered || rn.lives <= 0) return;
  rn.answered = true;
  cancelAnimationFrame(rn.animFrame);
  sfxClick();

  const allBtns = document.querySelectorAll('.run-option');
  allBtns.forEach(b => b.disabled = true);

  if (chosen === word.en) {
    // âœ… Correct
    sfxCorrect();
    rn.streak++;
    rn.wordsAnswered++;
    rn.bestStreak = Math.max(rn.bestStreak, rn.streak);
    const speedBonus = (rn.speedLevel + 1);
    const streakBonus = Math.min(rn.streak, 5);
    const pts = 10 * state.currentLevel * speedBonus + streakBonus * 5;
    rn.score += pts;

    btn.classList.add('correct');
    if (rn.wordEl) {
      rn.wordEl.classList.add('correct-flash');
      rn.wordEl.textContent = 'âœ“ ' + word.en;
    }

    // Speed up every 5 correct answers
    if (rn.wordsAnswered % 5 === 0 && rn.speedLevel < RUN_SPEEDS.length - 1) {
      rn.speedLevel++;
    }

    updateRunHUD();
    rn.idx++;
    setTimeout(() => spawnRunWord(), 600);

  } else {
    // âŒ Wrong
    sfxWrong();
    rn.streak = 0;
    rn.lives--;

    btn.classList.add('wrong');
    allBtns.forEach(b => { if (b.textContent === word.en) b.classList.add('correct'); });
    if (rn.wordEl) {
      rn.wordEl.classList.add('wrong-flash');
      rn.wordEl.classList.add('shake');
    }

    updateRunHUD();

    if (rn.lives <= 0) {
      setTimeout(() => endRun(), 800);
    } else {
      rn.idx++;
      setTimeout(() => spawnRunWord(), 900);
    }
  }
}

function wordEscaped() {
  if (rn.answered) return;
  rn.answered = true;
  sfxWrong();
  rn.streak = 0;
  rn.lives--;

  if (rn.wordEl) {
    rn.wordEl.style.background = 'var(--accent)';
    rn.wordEl.textContent = 'âœ— ' + rn.currentWord.en;
  }

  // flash correct answer
  const allBtns = document.querySelectorAll('.run-option');
  allBtns.forEach(b => {
    b.disabled = true;
    if (b.textContent === rn.currentWord.en) b.classList.add('correct');
  });

  updateRunHUD();

  if (rn.lives <= 0) {
    setTimeout(() => endRun(), 900);
  } else {
    rn.idx++;
    setTimeout(() => spawnRunWord(), 900);
  }
}

function updateRunHUD() {
  const hearts = ['', 'â¤ï¸', 'â¤ï¸â¤ï¸', 'â¤ï¸â¤ï¸â¤ï¸'];
  document.getElementById('run-lives').textContent = hearts[Math.max(0, rn.lives)] || 'ğŸ’€';
  document.getElementById('run-score-disp').textContent = rn.score;

  // Speed dots
  for (let i = 1; i <= 5; i++) {
    document.getElementById('spd' + i).className =
      'run-speed-dot' + (i <= rn.speedLevel + 1 ? ' lit' : '');
  }
}

function endRun() {
  cancelAnimationFrame(rn.animFrame);
  sfxComplete();

  if (rn.score > (state.bestScores.run || 0)) state.bestScores.run = rn.score;
  state.totalScore += rn.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'run', score: rn.score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸƒ' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('totalScore').textContent = state.totalScore;
  document.getElementById('run-game').style.display = 'none';
  document.getElementById('run-results').style.display = 'block';

  const great = rn.score > 200;
  document.getElementById('run-res-icon').textContent = great ? 'ğŸ†' : rn.wordsAnswered > 5 ? 'â­' : 'ğŸ’ª';
  document.getElementById('run-res-title').textContent = great ? '××“×”×™×!' : rn.wordsAnswered > 5 ? '×™×¤×”!' : '×”××©×š ×œ×ª×¨×’×œ!';
  document.getElementById('run-res-score').textContent = rn.score;
  document.getElementById('run-res-words').textContent = rn.wordsAnswered;
  document.getElementById('run-res-streak').textContent = rn.bestStreak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LISTEN GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ln = {};

// Check TTS support
function ttsSupported() {
  return 'speechSynthesis' in window;
}

function initListen() {
  if (!ttsSupported()) {
    alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×©××¢×ª ×§×•×œ. × ×¡×” ×‘-Chrome ××• Safari.');
    goHome(); return;
  }

  const allWords = getAvailableWords(state.currentLevel);
  if (allWords.length < 6) { alert('×¦×¨×™×š ×œ×¤×—×•×ª 6 ××™×œ×™×!'); return; }

  // Pick 10 target words for this round
  ln.targets  = shuffle([...allWords]).slice(0, 10);
  ln.all      = allWords;
  ln.idx      = 0;          // which target word we're on
  ln.score    = 0;
  ln.correct1 = 0;          // correct on first try
  ln.totalReplays = 0;
  ln.done     = false;

  document.getElementById('listen-game').style.display = 'block';
  document.getElementById('listen-results').style.display = 'none';
  document.getElementById('listen-feedback').className = 'feedback-banner';

  renderListenRound();
}

function renderListenRound() {
  const target = ln.targets[ln.idx];
  ln.replays   = 0;
  ln.firstTry  = true;
  ln.answered  = false;

  // Progress
  document.getElementById('listen-progress').textContent = `${ln.idx + 1} / ${ln.targets.length}`;
  document.getElementById('listen-bar').style.width = `${((ln.idx + 1) / ln.targets.length) * 100}%`;
  document.getElementById('listen-feedback').className = 'feedback-banner';
  document.getElementById('listenHebrew').textContent = '';
  document.getElementById('listenHebrew').className = 'listen-hebrew';
  document.getElementById('listenReplays').textContent = '×œ×—×¥ ×œ×”×©××¢×”';
  document.getElementById('listenFoundMsg').textContent = '';
  document.getElementById('listenPlayBtn').className = 'listen-play-btn';

  // Build grid: target + 8 distractors (3 cols Ã— 3 rows = 9 words)
  const distractors = shuffle(ln.all.filter(w => w.en !== target.en)).slice(0, 8);
  const gridWords   = shuffle([target, ...distractors]);
  ln.gridWords      = gridWords;

  const grid = document.getElementById('listenGrid');
  grid.innerHTML = '';
  gridWords.forEach(w => {
    const btn = document.createElement('button');
    btn.className = 'listen-word-btn';
    btn.textContent = w.en;
    btn.dataset.en = w.en;
    btn.onclick = () => handleListenTap(w, btn);
    grid.appendChild(btn);
  });

  // Auto-speak after short delay
  setTimeout(() => listenSpeak(), 400);
}

function listenSpeak() {
  if (ln.answered) return;
  const target = ln.targets[ln.idx];

  // Cancel any ongoing speech
  window.speechSynthesis.cancel();

  const utt = new SpeechSynthesisUtterance(target.en);
  utt.lang  = 'en-US';
  utt.rate  = 0.85;
  utt.pitch = 1;

  const btn = document.getElementById('listenPlayBtn');
  btn.className = 'listen-play-btn speaking';

  utt.onend = () => {
    btn.className = 'listen-play-btn';
  };
  utt.onerror = () => {
    btn.className = 'listen-play-btn';
  };

  window.speechSynthesis.speak(utt);

  if (ln.replays > 0) {
    ln.totalReplays++;
    document.getElementById('listenReplays').textContent = `×”×•×©××¢ ${ln.replays + 1} ×¤×¢××™×`;
  } else {
    document.getElementById('listenReplays').textContent = '×œ×—×¥ ×©×•×‘ ×œ×—×–×¨×” ğŸ”';
  }
  ln.replays++;
}

function handleListenTap(word, btn) {
  if (ln.answered) return;
  const target = ln.targets[ln.idx];
  sfxClick();

  if (word.en === target.en) {
    // âœ… Correct
    ln.answered = true;
    sfxCorrect();
    window.speechSynthesis.cancel();
    document.getElementById('listenPlayBtn').className = 'listen-play-btn';

    const replayPenalty = Math.min(ln.replays - 1, 4) * 5;
    const pts = Math.max(10, (20 * state.currentLevel) - replayPenalty);
    ln.score += pts;
    if (ln.firstTry) ln.correct1++;

    btn.className = 'listen-word-btn correct';
    btn.disabled = true;

    // Show Hebrew translation
    const heb = document.getElementById('listenHebrew');
    heb.textContent = target.he;
    heb.className = 'listen-hebrew visible';

    // Floating score popup
    showListenPoints('+' + pts);

    const fb = document.getElementById('listen-feedback');
    fb.className = 'feedback-banner correct';
    fb.textContent = ln.firstTry
      ? `âœ… × ×›×•×Ÿ! "${target.en}" = ${target.he}`
      : `âœ… × ×›×•×Ÿ! (××—×¨×™ ${ln.replays - 1} ×—×–×¨×•×ª)`;

    ln.idx++;
    if (ln.idx >= ln.targets.length) {
      setTimeout(() => endListen(), 1400);
    } else {
      setTimeout(() => renderListenRound(), 1500);
    }

  } else {
    // âŒ Wrong
    sfxWrong();
    ln.firstTry = false;
    btn.classList.add('wrong');
    setTimeout(() => {
      btn.classList.remove('wrong');
    }, 500);

    const fb = document.getElementById('listen-feedback');
    fb.className = 'feedback-banner wrong';
    fb.textContent = 'âŒ ×œ× × ×›×•×Ÿ â€” × ×¡×” ×©×•×‘!';
  }
}

function showListenPoints(text) {
  const area = document.querySelector('.listen-speak-area');
  const el = document.createElement('div');
  el.className = 'listen-pts-popup';
  el.textContent = text;
  area.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

function endListen() {
  window.speechSynthesis.cancel();
  ln.done = true;

  if (ln.score > (state.bestScores.listen || 0)) state.bestScores.listen = ln.score;
  state.totalScore += ln.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'listen', score: ln.score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸ”Š' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('totalScore').textContent = state.totalScore;
  document.getElementById('listen-game').style.display = 'none';
  document.getElementById('listen-results').style.display = 'block';

  const pct = Math.round((ln.correct1 / ln.targets.length) * 100);
  document.getElementById('listen-res-icon').textContent = pct >= 80 ? 'ğŸ†' : pct >= 50 ? 'ğŸŒŸ' : 'ğŸ’ª';
  document.getElementById('listen-res-title').textContent = pct >= 80 ? '××¦×•×™×Ÿ!' : pct >= 50 ? '×™×¤×”!' : '×”××©×š ×œ×ª×¨×’×œ!';
  document.getElementById('listen-res-score').textContent = ln.score;
  document.getElementById('listen-res-correct').textContent = `${ln.correct1}/${ln.targets.length}`;
  document.getElementById('listen-res-replays').textContent = ln.totalReplays;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLORS GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS_DB = [
  { en: 'red',    he: '××“×•×',    hex: '#ef4444' },
  { en: 'blue',   he: '×›×—×•×œ',   hex: '#3b82f6' },
  { en: 'yellow', he: '×¦×”×•×‘',   hex: '#facc15' },
  { en: 'green',  he: '×™×¨×•×§',   hex: '#22c55e' },
  { en: 'orange', he: '×›×ª×•×',   hex: '#f97316' },
  { en: 'purple', he: '×¡×’×•×œ',   hex: '#a855f7' },
  { en: 'pink',   he: '×•×¨×•×“',   hex: '#ec4899' },
  { en: 'black',  he: '×©×—×•×¨',   hex: '#1f2937' },
  { en: 'white',  he: '×œ×‘×Ÿ',    hex: '#f1f5f9' },
  { en: 'brown',  he: '×—×•×',    hex: '#92400e' },
  { en: 'gray',   he: '××¤×•×¨',   hex: '#6b7280' },
  { en: 'cyan',   he: '×ª×›×œ×ª',   hex: '#06b6d4' },
];

let cl = {};

function initColors() {
  if (!ttsSupported()) {
    alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×©××¢×ª ×§×•×œ. × ×¡×” ×‘-Chrome ××• Safari.');
    goHome(); return;
  }

  // Pick 10 rounds from the full color list
  cl.targets    = shuffle([...COLORS_DB]).slice(0, 10);
  cl.idx        = 0;
  cl.score      = 0;
  cl.streak     = 0;
  cl.bestStreak = 0;
  cl.correct1   = 0;
  cl.done       = false;

  document.getElementById('colors-game').style.display = 'block';
  document.getElementById('colors-results').style.display = 'none';

  renderColorsRound();
}

function renderColorsRound() {
  const target = cl.targets[cl.idx];
  cl.firstTry = true;
  cl.answered = false;

  // Progress
  const total = cl.targets.length;
  document.getElementById('colors-progress').textContent = `${cl.idx + 1} / ${total}`;
  document.getElementById('colors-bar').style.width = `${((cl.idx + 1) / total) * 100}%`;
  document.getElementById('colorsHint').textContent = '×œ×—×¥ ×¢×œ ×”×¦×‘×¢ ×”× ×›×•×Ÿ';
  document.getElementById('colorsQuestion').textContent = 'ğŸ”Š';
  document.getElementById('colorsSpeakBtn').className = 'colors-speak-btn';
  updateColorsHUD();

  // Build grid: target + distractors, always show ALL 12 colors (or fewer if less exist)
  // We show 6 swatches: target + 5 random distractors
  const distractors = shuffle(COLORS_DB.filter(c => c.en !== target.en)).slice(0, 5);
  const gridColors  = shuffle([target, ...distractors]);

  const grid = document.getElementById('colorsGrid');
  grid.innerHTML = '';
  gridColors.forEach(color => {
    const btn = document.createElement('button');
    btn.className = 'color-swatch';
    btn.style.background = color.hex;
    // white needs a border to be visible
    if (color.en === 'white') btn.style.border = '4px solid #cbd5e1';
    btn.dataset.en = color.en;
    btn.innerHTML = `<span class="swatch-label">${color.en}</span>`;
    btn.onclick = () => handleColorTap(color, btn);
    grid.appendChild(btn);
  });

  // Auto-speak after short delay
  setTimeout(() => colorsSpeak(), 500);
}

function colorsSpeak() {
  if (cl.answered) return;
  const target = cl.targets[cl.idx];
  window.speechSynthesis.cancel();

  const utt = new SpeechSynthesisUtterance(target.en);
  utt.lang  = 'en-US';
  utt.rate  = 0.8;
  utt.pitch = 1.1;

  const btn = document.getElementById('colorsSpeakBtn');
  btn.className = 'colors-speak-btn speaking';
  document.getElementById('colorsQuestion').textContent = 'ğŸ‘‚ ×©××¢ ×‘×¢×™×•×Ÿ...';

  utt.onend = utt.onerror = () => {
    btn.className = 'colors-speak-btn';
    document.getElementById('colorsQuestion').textContent = '××™×–×” ×¦×‘×¢ ×©××¢×ª? ğŸ¤”';
  };
  window.speechSynthesis.speak(utt);
}

function handleColorTap(color, btn) {
  if (cl.answered) return;
  const target = cl.targets[cl.idx];
  sfxClick();

  if (color.en === target.en) {
    // âœ… Correct!
    cl.answered = true;
    window.speechSynthesis.cancel();

    sfxCorrect();
    cl.streak++;
    cl.bestStreak = Math.max(cl.bestStreak, cl.streak);
    if (cl.firstTry) cl.correct1++;

    const pts = cl.firstTry ? 20 + cl.streak * 5 : 10;
    cl.score += pts;

    btn.classList.add('correct');
    document.getElementById('colorsQuestion').textContent = `âœ… ${target.en.toUpperCase()} â€” ${target.he}!`;
    document.getElementById('colorsHint').textContent = cl.firstTry
      ? `ğŸŒŸ ×›×œ ×”×›×‘×•×“! +${pts} × ×§×•×“×•×ª`
      : `ğŸ‘ × ×›×•×Ÿ!`;

    // Celebrate with emoji burst
    showColorsCelebration();
    updateColorsHUD();

    // Speak the color name again with praise
    setTimeout(() => {
      const utt2 = new SpeechSynthesisUtterance(`${target.en}! Great job!`);
      utt2.lang = 'en-US'; utt2.rate = 0.85;
      window.speechSynthesis.speak(utt2);
    }, 100);

    cl.idx++;
    if (cl.idx >= cl.targets.length) {
      setTimeout(() => endColors(), 1600);
    } else {
      setTimeout(() => renderColorsRound(), 1800);
    }

  } else {
    // âŒ Wrong
    sfxWrong();
    cl.firstTry = false;
    cl.streak   = 0;
    btn.classList.add('wrong');
    document.getElementById('colorsQuestion').textContent = 'âŒ ×œ× × ×›×•×Ÿ â€” × ×¡×” ×©×•×‘!';
    updateColorsHUD();
    setTimeout(() => btn.classList.remove('wrong'), 500);
  }
}

function showColorsCelebration() {
  const area = document.querySelector('.colors-speak-area');
  const emojis = ['ğŸ‰','â­','âœ¨','ğŸŒŸ','ğŸ’«','ğŸŠ'];
  const el = document.createElement('div');
  el.className = 'colors-celebrate';
  el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
  area.appendChild(el);
  setTimeout(() => el.remove(), 700);
}

function updateColorsHUD() {
  document.getElementById('colors-score-disp').textContent = cl.score;
  document.getElementById('colors-streak-disp').textContent = cl.streak + (cl.streak >= 3 ? 'ğŸ”¥' : '');
}

function endColors() {
  window.speechSynthesis.cancel();
  cl.done = true;

  if (cl.score > (state.bestScores.colors || 0)) state.bestScores.colors = cl.score;
  state.totalScore += cl.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'colors', score: cl.score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸ¨' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('totalScore').textContent = state.totalScore;
  document.getElementById('colors-game').style.display = 'none';
  document.getElementById('colors-results').style.display = 'block';

  const pct = Math.round((cl.correct1 / cl.targets.length) * 100);
  document.getElementById('colors-res-icon').textContent = pct === 100 ? 'ğŸ†' : pct >= 70 ? 'ğŸŒŸ' : 'ğŸ’ª';
  document.getElementById('colors-res-title').textContent = pct === 100 ? '××•×©×œ×! 100%!' : pct >= 70 ? '×™×¤×” ×××•×“!' : '×›×œ ×”×›×‘×•×“!';
  document.getElementById('colors-res-score').textContent = cl.score;
  document.getElementById('colors-res-correct').textContent = `${cl.correct1}/${cl.targets.length}`;
  document.getElementById('colors-res-streak').textContent = cl.bestStreak;

  // Speak final message
  const utt = new SpeechSynthesisUtterance(pct === 100 ? 'Amazing! Perfect score!' : 'Well done!');
  utt.lang = 'en-US'; utt.rate = 0.9;
  window.speechSynthesis.speak(utt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMOJI GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMOJI_CATEGORIES = {
  animals: {
    label: '×—×™×•×ª', emoji: 'ğŸ¾',
    items: [
      { en: 'dog',      he: '×›×œ×‘',    icon: 'ğŸ¶' },
      { en: 'cat',      he: '×—×ª×•×œ',   icon: 'ğŸ±' },
      { en: 'cow',      he: '×¤×¨×”',    icon: 'ğŸ„' },
      { en: 'horse',    he: '×¡×•×¡',    icon: 'ğŸ´' },
      { en: 'pig',      he: '×—×–×™×¨',   icon: 'ğŸ·' },
      { en: 'sheep',    he: '×›×‘×©×”',   icon: 'ğŸ‘' },
      { en: 'elephant', he: '×¤×™×œ',    icon: 'ğŸ˜' },
      { en: 'lion',     he: '××¨×™×”',   icon: 'ğŸ¦' },
      { en: 'monkey',   he: '×§×•×£',    icon: 'ğŸ’' },
      { en: 'frog',     he: '×¦×¤×¨×“×¢',  icon: 'ğŸ¸' },
      { en: 'penguin',  he: '×¤×™× ×’×•×•×™×Ÿ', icon: 'ğŸ§' },
      { en: 'rabbit',   he: '××¨× ×‘',   icon: 'ğŸ°' },
      { en: 'bear',     he: '×“×•×‘',    icon: 'ğŸ»' },
      { en: 'fox',      he: '×©×•×¢×œ',   icon: 'ğŸ¦Š' },
      { en: 'duck',     he: '×‘×¨×•×•×–',  icon: 'ğŸ¦†' },
    ]
  },
  fruits: {
    label: '×¤×™×¨×•×ª', emoji: 'ğŸ',
    items: [
      { en: 'apple',      he: '×ª×¤×•×—',      icon: 'ğŸ' },
      { en: 'banana',     he: '×‘× × ×”',      icon: 'ğŸŒ' },
      { en: 'grapes',     he: '×¢× ×‘×™×',     icon: 'ğŸ‡' },
      { en: 'strawberry', he: '×ª×•×ª',       icon: 'ğŸ“' },
      { en: 'watermelon', he: '××‘×˜×™×—',     icon: 'ğŸ‰' },
      { en: 'orange',     he: '×ª×¤×•×–',      icon: 'ğŸŠ' },
      { en: 'pineapple',  he: '×× × ×¡',      icon: 'ğŸ' },
      { en: 'mango',      he: '×× ×’×•',      icon: 'ğŸ¥­' },
      { en: 'peach',      he: '××¤×¨×¡×§',     icon: 'ğŸ‘' },
      { en: 'cherry',     he: '×“×•×‘×“×‘×Ÿ',    icon: 'ğŸ’' },
      { en: 'lemon',      he: '×œ×™××•×Ÿ',     icon: 'ğŸ‹' },
      { en: 'pear',       he: '××’×¡',       icon: 'ğŸ' },
    ]
  },
  vehicles: {
    label: '×›×œ×™ ×¨×›×‘', emoji: 'ğŸš—',
    items: [
      { en: 'car',        he: '××›×•× ×™×ª',    icon: 'ğŸš—' },
      { en: 'bus',        he: '××•×˜×•×‘×•×¡',   icon: 'ğŸšŒ' },
      { en: 'train',      he: '×¨×›×‘×ª',      icon: 'ğŸš‚' },
      { en: 'airplane',   he: '××˜×•×¡',      icon: 'âœˆï¸' },
      { en: 'boat',       he: '×¡×™×¨×”',      icon: 'â›µ' },
      { en: 'bicycle',    he: '××•×¤× ×™×™×',   icon: 'ğŸš²' },
      { en: 'rocket',     he: '×˜×™×œ',       icon: 'ğŸš€' },
      { en: 'helicopter', he: '××¡×•×§',      icon: 'ğŸš' },
      { en: 'truck',      he: '××©××™×ª',     icon: 'ğŸš›' },
      { en: 'ambulance',  he: '×××‘×•×œ× ×¡',   icon: 'ğŸš‘' },
      { en: 'fire truck', he: '××›×‘×™ ××©',   icon: 'ğŸš’' },
      { en: 'tractor',    he: '×˜×¨×§×˜×•×¨',    icon: 'ğŸšœ' },
    ]
  },
  food: {
    label: '××•×›×œ', emoji: 'ğŸ•',
    items: [
      { en: 'pizza',      he: '×¤×™×¦×”',      icon: 'ğŸ•' },
      { en: 'hamburger',  he: '×”××‘×•×¨×’×¨',   icon: 'ğŸ”' },
      { en: 'ice cream',  he: '×’×œ×™×“×”',     icon: 'ğŸ¦' },
      { en: 'cake',       he: '×¢×•×’×”',      icon: 'ğŸ‚' },
      { en: 'bread',      he: '×œ×—×',       icon: 'ğŸ' },
      { en: 'egg',        he: '×‘×™×¦×”',      icon: 'ğŸ¥š' },
      { en: 'cheese',     he: '×’×‘×™× ×”',     icon: 'ğŸ§€' },
      { en: 'cookie',     he: '×¢×•×’×™×™×”',    icon: 'ğŸª' },
      { en: 'sandwich',   he: '×›×¨×™×š',      icon: 'ğŸ¥ª' },
      { en: 'sushi',      he: '×¡×•×©×™',      icon: 'ğŸ£' },
      { en: 'hot dog',    he: "× ×§× ×™×§×™×™×”",  icon: 'ğŸŒ­' },
      { en: 'popcorn',    he: '×¤×•×¤×§×•×¨×Ÿ',   icon: 'ğŸ¿' },
    ]
  },
  sports: {
    label: '×¡×¤×•×¨×˜', emoji: 'âš½',
    items: [
      { en: 'soccer',     he: '×›×“×•×¨×’×œ',    icon: 'âš½' },
      { en: 'basketball', he: '×›×“×•×¨×¡×œ',    icon: 'ğŸ€' },
      { en: 'tennis',     he: '×˜× ×™×¡',      icon: 'ğŸ¾' },
      { en: 'swimming',   he: '×©×—×™×™×”',     icon: 'ğŸŠ' },
      { en: 'cycling',    he: '×¨×›×™×‘×”',     icon: 'ğŸš´' },
      { en: 'skiing',     he: '×¡×§×™',       icon: 'â›·ï¸' },
      { en: 'golf',       he: '×’×•×œ×£',      icon: 'â›³' },
      { en: 'boxing',     he: '××’×¨×•×£',     icon: 'ğŸ¥Š' },
      { en: 'baseball',   he: '×‘×™×™×¡×‘×•×œ',   icon: 'âš¾' },
      { en: 'volleyball', he: '×›×“×•×¨×¢×£',    icon: 'ğŸ' },
      { en: 'archery',    he: '×§×©×ª×•×ª',     icon: 'ğŸ¹' },
      { en: 'surfing',    he: '×’×œ×™×©×”',     icon: 'ğŸ„' },
    ]
  },
  nature: {
    label: '×˜×‘×¢', emoji: 'ğŸŒ³',
    items: [
      { en: 'sun',        he: '×©××©',       icon: 'â˜€ï¸' },
      { en: 'moon',       he: '×™×¨×—',       icon: 'ğŸŒ™' },
      { en: 'star',       he: '×›×•×›×‘',      icon: 'â­' },
      { en: 'cloud',      he: '×¢× ×Ÿ',       icon: 'â˜ï¸' },
      { en: 'rain',       he: '×’×©×',       icon: 'ğŸŒ§ï¸' },
      { en: 'snow',       he: '×©×œ×’',       icon: 'â„ï¸' },
      { en: 'fire',       he: '××©',        icon: 'ğŸ”¥' },
      { en: 'tree',       he: '×¢×¥',        icon: 'ğŸŒ³' },
      { en: 'flower',     he: '×¤×¨×—',       icon: 'ğŸŒ¸' },
      { en: 'mountain',   he: '×”×¨',        icon: 'â›°ï¸' },
      { en: 'rainbow',    he: '×§×©×ª ×‘×¢× ×Ÿ',  icon: 'ğŸŒˆ' },
      { en: 'wave',       he: '×’×œ',        icon: 'ğŸŒŠ' },
    ]
  },
};

let em = {};
let emSelectedCats = new Set(['animals']); // default

function showEmojiSetup() {
  document.getElementById('emoji-setup').style.display = 'block';
  document.getElementById('emoji-game').style.display = 'none';
  document.getElementById('emoji-results').style.display = 'none';
  renderEmojiCatSelector();
}

function renderEmojiCatSelector() {
  const container = document.getElementById('emojiCatSelector');
  container.innerHTML = '';

  // "Mix all" button
  const mixBtn = document.createElement('button');
  mixBtn.className = 'emoji-cat-btn mix-btn' + (emSelectedCats.has('all') ? ' selected' : '');
  mixBtn.innerHTML = `<span class="cat-emoji">ğŸ²</span>×”×›×œ ××™×§×¡`;
  mixBtn.onclick = () => {
    if (emSelectedCats.has('all')) {
      emSelectedCats.delete('all');
    } else {
      emSelectedCats.clear();
      emSelectedCats.add('all');
    }
    renderEmojiCatSelector();
  };
  container.appendChild(mixBtn);

  Object.entries(EMOJI_CATEGORIES).forEach(([key, cat]) => {
    const btn = document.createElement('button');
    const sel = emSelectedCats.has(key) || emSelectedCats.has('all');
    btn.className = 'emoji-cat-btn' + (sel ? ' selected' : '');
    btn.innerHTML = `<span class="cat-emoji">${cat.emoji}</span>${cat.label}`;
    btn.onclick = () => {
      emSelectedCats.delete('all');
      if (emSelectedCats.has(key)) {
        emSelectedCats.delete(key);
        if (emSelectedCats.size === 0) emSelectedCats.add('all');
      } else {
        emSelectedCats.add(key);
      }
      renderEmojiCatSelector();
    };
    container.appendChild(btn);
  });
}

function getEmojiPool() {
  if (emSelectedCats.has('all')) {
    return Object.values(EMOJI_CATEGORIES).flatMap(c => c.items);
  }
  let pool = [];
  emSelectedCats.forEach(key => {
    if (EMOJI_CATEGORIES[key]) pool = pool.concat(EMOJI_CATEGORIES[key].items);
  });
  return pool;
}

function startEmojiGame() {
  if (!ttsSupported()) { alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×©××¢×ª ×§×•×œ.'); return; }
  const pool = getEmojiPool();
  if (pool.length < 6) { alert('×‘×—×¨ ×œ×¤×—×•×ª ×§×˜×’×•×¨×™×” ××—×ª ×¢× ××¡×¤×™×§ ×¤×¨×™×˜×™×!'); return; }

  em.pool       = pool;
  em.targets    = shuffle([...pool]).slice(0, 10);
  em.idx        = 0;
  em.score      = 0;
  em.streak     = 0;
  em.bestStreak = 0;
  em.correct1   = 0;

  document.getElementById('emoji-setup').style.display = 'none';
  document.getElementById('emoji-game').style.display = 'block';
  document.getElementById('emoji-results').style.display = 'none';
  document.getElementById('emoji-feedback').className = 'feedback-banner';

  renderEmojiRound();
}

function renderEmojiRound() {
  const target = em.targets[em.idx];
  em.firstTry = true;
  em.answered = false;

  document.getElementById('emoji-progress').textContent = `${em.idx + 1} / ${em.targets.length}`;
  document.getElementById('emoji-bar').style.width = `${((em.idx + 1) / em.targets.length) * 100}%`;
  document.getElementById('emoji-feedback').className = 'feedback-banner';
  document.getElementById('emojiQuestion').textContent = '×œ×—×¥ ×œ×”×©××¢×” ğŸ”Š';
  document.getElementById('emojiHint').textContent = '×’×¢ ×‘×ª××•× ×” ×”× ×›×•× ×”';
  document.getElementById('emojiSpeakBtn').className = 'emoji-speak-btn';
  updateEmojiHUD();

  // 6 tiles: target + 5 distractors â€” displayed in 2Ã—3 grid
  const distractors = shuffle(em.pool.filter(i => i.en !== target.en)).slice(0, 5);
  const tiles = shuffle([target, ...distractors]);

  const grid = document.getElementById('emojiGrid');
  grid.innerHTML = '';
  tiles.forEach(item => {
    const div = document.createElement('div');
    div.className = 'emoji-tile';
    div.innerHTML = `<span class="tile-icon">${item.icon}</span><span class="tile-label">${item.en}</span>`;
    div.addEventListener('click', () => handleEmojiTap(item, div));
    grid.appendChild(div);
  });

  // Size tiles with JS â€” exact same approach as working test
  requestAnimationFrame(() => {
    const gridW = grid.offsetWidth;
    const tileSize = Math.floor((gridW - 12) / 2); // 2 cols, gap 12px
    const iconSize = Math.floor(tileSize * 0.55);
    grid.querySelectorAll('.emoji-tile').forEach(t => {
      t.style.width  = tileSize + 'px';
      t.style.height = tileSize + 'px';
    });
    grid.querySelectorAll('.tile-icon').forEach(s => {
      s.style.fontSize = iconSize + 'px';
    });
  });

  setTimeout(() => emojiSpeak(), 400);
}

function emojiSpeak() {
  if (em.answered) return;
  const target = em.targets[em.idx];
  window.speechSynthesis.cancel();

  const utt = new SpeechSynthesisUtterance(target.en);
  utt.lang = 'en-US'; utt.rate = 0.82; utt.pitch = 1.1;

  const btn = document.getElementById('emojiSpeakBtn');
  btn.className = 'emoji-speak-btn speaking';
  document.getElementById('emojiQuestion').textContent = 'ğŸ‘‚ ×©××¢...';

  utt.onend = utt.onerror = () => {
    btn.className = 'emoji-speak-btn';
    document.getElementById('emojiQuestion').textContent = `××” ×–×” ${target.en}? ğŸ¤”`;
  };  window.speechSynthesis.speak(utt);
}

function handleEmojiTap(item, btn) {
  if (em.answered) return;
  const target = em.targets[em.idx];
  sfxClick();

  if (item.en === target.en) {
    em.answered = true;
    window.speechSynthesis.cancel();
    sfxCorrect();

    em.streak++;
    em.bestStreak = Math.max(em.bestStreak, em.streak);
    if (em.firstTry) em.correct1++;
    const pts = em.firstTry ? 20 + Math.min(em.streak, 5) * 4 : 8;
    em.score += pts;

    btn.classList.add('correct');
    document.getElementById('emojiQuestion').textContent = `âœ… ${target.en} â€” ${target.he}!`;
    document.getElementById('emojiHint').textContent = em.firstTry ? `ğŸŒŸ ×›×œ ×”×›×‘×•×“! +${pts}` : `ğŸ‘ × ×›×•×Ÿ!`;
    document.getElementById('emoji-feedback').className = 'feedback-banner correct';
    document.getElementById('emoji-feedback').textContent = `âœ… ${target.icon} = ${target.en}`;

    updateEmojiHUD();

    // Praise speech
    setTimeout(() => {
      const utt = new SpeechSynthesisUtterance(`${target.en}! ${em.firstTry ? 'Amazing!' : 'Good job!'}`);
      utt.lang = 'en-US'; utt.rate = 0.88;
      window.speechSynthesis.speak(utt);
    }, 80);

    em.idx++;
    if (em.idx >= em.targets.length) {
      setTimeout(() => endEmoji(), 1600);
    } else {
      setTimeout(() => renderEmojiRound(), 1800);
    }

  } else {
    sfxWrong();
    em.firstTry = false;
    em.streak = 0;
    btn.classList.add('wrong');
    document.getElementById('emojiQuestion').textContent = 'âŒ × ×¡×” ×©×•×‘!';
    updateEmojiHUD();
    setTimeout(() => btn.classList.remove('wrong'), 500);
  }
}

function updateEmojiHUD() {
  document.getElementById('emoji-score-disp').textContent = em.score;
  document.getElementById('emoji-streak-disp').textContent = em.streak + (em.streak >= 3 ? 'ğŸ”¥' : '');
}

function endEmoji() {
  window.speechSynthesis.cancel();
  if (em.score > (state.bestScores.emoji || 0)) state.bestScores.emoji = em.score;
  state.totalScore += em.score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'emoji', score: em.score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸ˜€' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('totalScore').textContent = state.totalScore;
  document.getElementById('emoji-game').style.display = 'none';
  document.getElementById('emoji-results').style.display = 'block';

  const pct = Math.round((em.correct1 / em.targets.length) * 100);
  document.getElementById('emoji-res-icon').textContent = pct === 100 ? 'ğŸ†' : pct >= 70 ? 'ğŸŒŸ' : 'ğŸ’ª';
  document.getElementById('emoji-res-title').textContent = pct === 100 ? '××•×©×œ×! ğŸ’¯' : pct >= 70 ? '×™×¤×” ×××•×“!' : '×›×œ ×”×›×‘×•×“!';
  document.getElementById('emoji-res-score').textContent = em.score;
  document.getElementById('emoji-res-correct').textContent = `${em.correct1}/${em.targets.length}`;
  document.getElementById('emoji-res-streak').textContent = em.bestStreak;

  const utt = new SpeechSynthesisUtterance(pct === 100 ? 'Perfect! Amazing job!' : 'Well done!');
  utt.lang = 'en-US'; utt.rate = 0.9;
  window.speechSynthesis.speak(utt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOM PACKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingPackId = null;

function showTab2(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  navigateTo(name);
  if (name === 'custom') renderPacksScreen();
}

function renderPacksScreen() {
  const packs = state.customPacks || [];
  const list = document.getElementById('packList');
  const noMsg = document.getElementById('noPacksMsg');
  noMsg.style.display = packs.length === 0 ? 'block' : 'none';

  list.innerHTML = '';
  packs.forEach(pack => {
    const el = document.createElement('div');
    el.className = 'pack-item';
    el.style.cursor = 'default';
    el.innerHTML = `
      <div class="pack-item-info" style="flex:1">
        <div class="pack-item-name">${pack.name}</div>
        <div class="pack-item-count">${pack.words.length} ××™×œ×™×</div>
      </div>
      <button class="pack-item-edit" onclick="editPack('${pack.id}')" title="×¢×¨×•×š">âœï¸</button>
      <button class="pack-item-delete" onclick="deletePack('${pack.id}',event)" title="××—×§">ğŸ—‘ï¸</button>
    `;
    list.appendChild(el);
  });

  // reset form to "new" mode
  cancelEdit();
}

function editPack(id) {
  const pack = (state.customPacks || []).find(p => p.id === id);
  if (!pack) return;
  editingPackId = id;
  document.getElementById('packFormTitle').textContent = `âœï¸ ×¢×¨×™×›×ª: ${pack.name}`;
  document.getElementById('packNameInput').value = pack.name;
  // Fill textarea with current words
  document.getElementById('packWordsInput').value = pack.words.map(w => `${w.en} - ${w.he}`).join('\n');
  document.getElementById('cancelEditBtn').style.display = 'block';
  document.getElementById('previewWrap').style.display = 'none';
  document.getElementById('translateBtn').style.display = 'block';
  document.getElementById('savePackBtn').style.display = 'none';
  document.getElementById('translateStatus').className = 'translate-status';
  document.getElementById('packForm').scrollIntoView({ behavior: 'smooth' });
}

function cancelEdit() {
  editingPackId = null;
  document.getElementById('packFormTitle').textContent = 'â• ×—×‘×™×œ×” ×—×“×©×”';
  document.getElementById('packNameInput').value = '';
  document.getElementById('packWordsInput').value = '';
  document.getElementById('cancelEditBtn').style.display = 'none';
  document.getElementById('previewWrap').style.display = 'none';
  document.getElementById('translateBtn').style.display = 'block';
  document.getElementById('savePackBtn').style.display = 'none';
  document.getElementById('translateStatus').className = 'translate-status';
  pendingWords = [];
}

function deletePack(id, e) {
  if (e) e.stopPropagation();
  if (!confirm('×œ××—×•×§ ××ª ×”×—×‘×™×œ×”?')) return;
  state.customPacks = (state.customPacks || []).filter(p => p.id !== id);
  state.activeSources = (state.activeSources || ['builtin']).filter(s => s !== id);
  if (!state.activeSources.length) state.activeSources = ['builtin'];
  saveState();
  renderPacksScreen();
  updateSourcesUI();
}

// â”€â”€ Sources dropdown â”€â”€
function toggleDropdown(id, btn) {
  const panel = document.getElementById(id);
  const isOpen = panel.classList.contains('open');
  // close all dropdowns
  document.querySelectorAll('.dropdown-panel').forEach(p => p.classList.remove('open'));
  document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
  if (!isOpen) {
    panel.classList.add('open');
    btn.classList.add('active');
    if (id === 'sourcesDrop') renderSourcesDropdown();
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.home-controls')) {
    document.querySelectorAll('.dropdown-panel').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
  }
});

function renderSourcesDropdown() {
  const sources = state.activeSources || ['builtin'];
  const packs = state.customPacks || [];

  // builtin item
  const builtinEl = document.getElementById('src-builtin');
  const builtinChecked = sources.includes('builtin');
  builtinEl.className = 'dropdown-item' + (builtinChecked ? ' checked' : '');
  builtinEl.querySelector('.chk').textContent = builtinChecked ? 'âœ“' : '';

  // custom packs
  const listEl = document.getElementById('srcCustomList');
  const emptyEl = document.getElementById('srcEmptyMsg');
  listEl.innerHTML = '';
  emptyEl.style.display = packs.length === 0 ? 'block' : 'none';
  packs.forEach(pack => {
    const checked = sources.includes(pack.id);
    const div = document.createElement('div');
    div.className = 'dropdown-item' + (checked ? ' checked' : '');
    div.innerHTML = `<span class="chk">${checked ? 'âœ“' : ''}</span> ${pack.name}`;
    div.onclick = () => toggleSource(pack.id);
    listEl.appendChild(div);
  });
}

function toggleSource(id) {
  let sources = [...(state.activeSources || ['builtin'])];
  if (sources.includes(id)) {
    sources = sources.filter(s => s !== id);
  } else {
    sources.push(id);
  }
  if (sources.length === 0) sources = ['builtin']; // ×œ× ×××¤×©×¨ ×‘×—×™×¨×” ×¨×™×§×”
  state.activeSources = sources;
  saveState();
  renderSourcesDropdown();
  updateSourcesUI();
}

function updateSourcesUI() {
  const sources = state.activeSources || ['builtin'];
  const packs = state.customPacks || [];
  const parts = [];
  if (sources.includes('builtin')) parts.push('××•×‘× ×•×ª');
  packs.forEach(p => { if (sources.includes(p.id)) parts.push(p.name); });
  const label = parts.length <= 1 ? parts[0] || '××§×•×¨×•×ª' : `${parts.length} ××§×•×¨×•×ª`;
  document.getElementById('sourcesBtnLabel').textContent = label;
  const btn = document.getElementById('sourcesBtn');
  const hasCustom = sources.some(s => s !== 'builtin');
  btn.style.borderColor = hasCustom ? 'var(--accent)' : '';
  btn.style.color = hasCustom ? 'var(--accent)' : '';
  updateUI(); // refresh fill card disabled state
}

// â”€â”€ Level dropdown â”€â”€
const LEVEL_NAMES = { 1: '×¨××” 1 â€” ××ª×—×™×œ', 2: '×¨××” 2 â€” ×™×¡×•×“×™', 3: '×¨××” 3 â€” ×‘×™× ×•× ×™', 4: '×¨××” 4 â€” ××ª×§×“×' };
function selectLevelDrop(lvl) {
  state.currentLevel = lvl;
  saveState();
  document.getElementById('levelBtnLabel').textContent = LEVEL_NAMES[lvl];
  [1,2,3,4].forEach(l => {
    document.getElementById('lvlOpt'+l).className = 'dropdown-item' + (l === lvl ? ' selected' : '');
  });
  document.getElementById('levelDrop').classList.remove('open');
  document.getElementById('levelBtn').classList.remove('active');
  updateAddWordsUI();
}

// keep old selectLevel working for anything that calls it
function selectLevel(lvl) { selectLevelDrop(lvl); }

// â”€â”€ Translation â”€â”€
async function translateWord(word) {
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|he`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.responseStatus === 200) return data.responseData.translatedText;
  throw new Error('failed');
}

let pendingWords = [];

async function translateAndPreview() {
  const nameVal = document.getElementById('packNameInput').value.trim();
  const rawText = document.getElementById('packWordsInput').value.trim();
  if (!nameVal) { alert('× × ×œ×”×›× ×™×¡ ×©× ×œ×—×‘×™×œ×”'); return; }
  if (!rawText) { alert('× × ×œ×”×›× ×™×¡ ××™×œ×™×'); return; }

  const lines = rawText.split('\n').map(l => l.trim()).filter(Boolean);
  pendingWords = [];
  lines.forEach(line => {
    const dash = line.indexOf(' - ');
    if (dash !== -1) {
      pendingWords.push({ en: line.slice(0, dash).trim(), he: line.slice(dash + 3).trim(), manual: true });
    } else {
      pendingWords.push({ en: line.trim(), he: '', manual: false });
    }
  });

  const statusEl = document.getElementById('translateStatus');
  const btn = document.getElementById('translateBtn');
  btn.disabled = true;
  btn.textContent = '××ª×¨×’×... â³';
  statusEl.className = 'translate-status visible';

  let failed = [];
  for (let i = 0; i < pendingWords.length; i++) {
    const w = pendingWords[i];
    if (!w.manual) {
      statusEl.textContent = `××ª×¨×’×: ${w.en} (${i+1}/${pendingWords.length})`;
      try { w.he = await translateWord(w.en); }
      catch { w.he = ''; failed.push(w.en); }
    }
  }

  btn.disabled = false;
  btn.textContent = '×ª×¨×’× ×•×‘× ×” ×—×‘×™×œ×” âœ¨';
  statusEl.textContent = failed.length > 0
    ? `âš ï¸ ×œ× ×”×¦×œ×™×— ×œ×ª×¨×’×: ${failed.join(', ')}`
    : `âœ… ×ª×•×¨×’×! ×¢×¨×•×š ×× ×¦×¨×™×š ×•×©××•×¨.`;

  const tbody = document.getElementById('previewBody');
  tbody.innerHTML = '';
  pendingWords.forEach((w, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${w.en}" onchange="pendingWords[${i}].en=this.value" dir="ltr"></td>
      <td><input value="${w.he}" onchange="pendingWords[${i}].he=this.value" dir="rtl"></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('previewWrap').style.display = 'block';
  document.getElementById('savePackBtn').style.display = 'block';
}

function savePack() {
  const name = document.getElementById('packNameInput').value.trim();
  const words = pendingWords
    .filter(w => w.en && w.he)
    .map(w => ({ en: w.en.trim(), he: w.he.trim(), ex: `${w.en.trim()}.` }));
  if (words.length < 4) { alert('×—×‘×™×œ×” ×¦×¨×™×›×” ×œ×¤×—×•×ª 4 ××™×œ×™× ×ª×§×™× ×•×ª'); return; }

  if (editingPackId) {
    // ×¢×“×›×•×Ÿ ×—×‘×™×œ×” ×§×™×™××ª
    state.customPacks = (state.customPacks || []).map(p =>
      p.id === editingPackId ? { ...p, name, words } : p
    );
    showToast(`âœ… "${name}" ×¢×•×“×›× ×”! (${words.length} ××™×œ×™×)`);
  } else {
    // ×—×‘×™×œ×” ×—×“×©×”
    const pack = { id: 'custom_' + Date.now(), name, words };
    state.customPacks = [...(state.customPacks || []), pack];
    showToast(`âœ… "${name}" × ×©××¨×”! (${words.length} ××™×œ×™×)`);
  }

  saveState();
  updateSourcesUI();
  renderPacksScreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let sfxEnabled = true;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playTone(freq, type, duration, volume, startTime, ctx) {
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, startTime);
  gain.gain.setValueAtTime(volume, startTime);
  gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
  osc.start(startTime);
  osc.stop(startTime + duration);
}

function sfxClick() {
  if (!sfxEnabled) return;
  const ctx = getAudioCtx();
  playTone(600, 'sine', 0.07, 0.08, ctx.currentTime, ctx);
}

function sfxCorrect() {
  if (!sfxEnabled) return;
  const ctx = getAudioCtx();
  const t = ctx.currentTime;
  playTone(523, 'sine', 0.12, 0.15, t, ctx);
  playTone(659, 'sine', 0.12, 0.15, t + 0.1, ctx);
  playTone(784, 'sine', 0.2,  0.18, t + 0.2, ctx);
}

function sfxWrong() {
  if (!sfxEnabled) return;
  const ctx = getAudioCtx();
  const t = ctx.currentTime;
  playTone(300, 'sawtooth', 0.12, 0.12, t, ctx);
  playTone(250, 'sawtooth', 0.18, 0.12, t + 0.12, ctx);
}

function sfxComplete() {
  if (!sfxEnabled) return;
  const ctx = getAudioCtx();
  const t = ctx.currentTime;
  const melody = [523,659,784,1047];
  melody.forEach((f, i) => playTone(f, 'sine', 0.18, 0.18, t + i * 0.14, ctx));
  playTone(1047, 'sine', 0.5, 0.22, t + melody.length * 0.14, ctx);
}

function toggleSfx() {
  sfxEnabled = !sfxEnabled;
  const btn = document.getElementById('sfx-btn');
  btn.textContent = sfxEnabled ? 'ğŸ”Š' : 'ğŸ”•';
  btn.title = sfxEnabled ? '×›×‘×” ×¦×œ×™×œ×™×' : '×”×¤×¢×œ ×¦×œ×™×œ×™×';
}

document.addEventListener('click', e => {
  if (e.target.matches('.option-btn, .flash-btn, .level-btn, .game-card, .btn-primary, .btn-secondary, .next-btn, .dir-btn')) {
    sfxClick();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATCH GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mt = {};

function setMatchCount(n, btn) {
  const maxCount = Math.min(getAvailableWords(state.currentLevel).length, 10);
  if (n > maxCount) return;
  mt.count = n;
  document.querySelectorAll('.match-count-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  initMatch();
}

function initMatch() {
  const allWords = getAvailableWords(state.currentLevel);
  const maxCount = Math.min(allWords.length, 10);
  if (allWords.length < 4) { alert('×¦×¨×™×š ×œ×¤×—×•×ª 4 ××™×œ×™× ×œ×”×ª×××”!'); return; }
  const count = Math.min(mt.count || 6, maxCount);
  mt.count = count;

  // Update count buttons to only show valid options
  document.querySelectorAll('.match-count-btn').forEach(btn => {
    const n = parseInt(btn.textContent);
    btn.disabled = n > maxCount;
    btn.style.opacity = n > maxCount ? '0.3' : '1';
    if (n === count) btn.classList.add('selected');
    else btn.classList.remove('selected');
  });
  mt.words = shuffle(allWords).slice(0, count);
  mt.matched = 0;
  mt.errors = 0;
  mt.selectedHe = null;
  mt.selectedEn = null;
  mt.startTime = Date.now();
  mt.elapsed = 0;
  mt.done = false;

  clearInterval(mt.timerInterval);
  mt.timerInterval = setInterval(updateMatchTimer, 500);

  document.getElementById('match-game').style.display = 'block';
  document.getElementById('match-results').style.display = 'none';
  document.getElementById('match-feedback').className = 'feedback-banner';
  updateMatchPairsLeft();

  // Build columns â€” Hebrew shuffled separately from English
  const heWords = shuffle([...mt.words]);
  const enWords = shuffle([...mt.words]);

  const heCol = document.getElementById('match-col-he');
  const enCol = document.getElementById('match-col-en');
  heCol.innerHTML = '';
  enCol.innerHTML = '';

  heWords.forEach(w => {
    const btn = document.createElement('button');
    btn.className = 'match-word';
    btn.dataset.id = w.en; // use English as unique key
    btn.dataset.lang = 'he';
    btn.textContent = w.he;
    btn.onclick = () => selectMatchWord(btn, 'he');
    heCol.appendChild(btn);
  });

  enWords.forEach(w => {
    const btn = document.createElement('button');
    btn.className = 'match-word';
    btn.dataset.id = w.en;
    btn.dataset.lang = 'en';
    btn.textContent = w.en;
    btn.onclick = () => selectMatchWord(btn, 'en');
    enCol.appendChild(btn);
  });
}

function updateMatchTimer() {
  if (mt.done) return;
  mt.elapsed = Math.floor((Date.now() - mt.startTime) / 1000);
  const mins = Math.floor(mt.elapsed / 60);
  const secs = mt.elapsed % 60;
  const timerEl = document.getElementById('match-timer');
  timerEl.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
  timerEl.className = 'match-timer' + (mt.elapsed > 60 ? ' warning' : '');
  // progress bar â€” based on matched pairs
  document.getElementById('match-progress-bar').style.width =
    `${(mt.matched / mt.count) * 100}%`;
}

function updateMatchPairsLeft() {
  document.getElementById('match-pairs-left').textContent =
    `${mt.matched}/${mt.count} ×–×•×’×•×ª`;
}

function selectMatchWord(btn, lang) {
  if (btn.classList.contains('matched')) return;
  sfxClick();

  if (lang === 'he') {
    // deselect previous he selection
    document.querySelectorAll('#match-col-he .match-word.selected')
      .forEach(b => b.classList.remove('selected'));
    mt.selectedHe = btn;
    btn.classList.add('selected');
  } else {
    document.querySelectorAll('#match-col-en .match-word.selected')
      .forEach(b => b.classList.remove('selected'));
    mt.selectedEn = btn;
    btn.classList.add('selected');
  }

  // check for match when both sides selected
  if (mt.selectedHe && mt.selectedEn) {
    checkMatchPair();
  }
}

function checkMatchPair() {
  const heBtn = mt.selectedHe;
  const enBtn = mt.selectedEn;
  mt.selectedHe = null;
  mt.selectedEn = null;

  if (heBtn.dataset.id === enBtn.dataset.id) {
    // âœ… Match!
    sfxCorrect();
    heBtn.classList.remove('selected');
    enBtn.classList.remove('selected');
    heBtn.classList.add('matched');
    enBtn.classList.add('matched');
    mt.matched++;
    updateMatchPairsLeft();
    updateMatchTimer();
    if (mt.matched === mt.count) {
      setTimeout(endMatch, 400);
    }
  } else {
    // âŒ Wrong
    sfxWrong();
    mt.errors++;
    heBtn.classList.remove('selected');
    enBtn.classList.remove('selected');
    heBtn.classList.add('wrong-flash');
    enBtn.classList.add('wrong-flash');
    setTimeout(() => {
      heBtn.classList.remove('wrong-flash');
      enBtn.classList.remove('wrong-flash');
    }, 500);
  }
}

function endMatch() {
  mt.done = true;
  clearInterval(mt.timerInterval);
  sfxComplete();

  // Score: base points per pair, time bonus, error penalty
  const baseScore = mt.count * 20 * state.currentLevel;
  const timeBonus = Math.max(0, 300 - mt.elapsed * 3);
  const errorPenalty = mt.errors * 15;
  const score = Math.max(0, baseScore + timeBonus - errorPenalty);

  if (score > (state.bestScores.match || 0)) state.bestScores.match = score;
  state.totalScore += score;
  state.gamesPlayed++;
  state.history.unshift({ type: 'match', score, date: new Date().toLocaleDateString('he-IL'), icon: 'ğŸ”—' });
  if (state.history.length > 20) state.history.pop();
  saveState();

  document.getElementById('totalScore').textContent = state.totalScore;
  document.getElementById('match-game').style.display = 'none';
  document.getElementById('match-results').style.display = 'block';

  const mins = Math.floor(mt.elapsed / 60);
  const secs = mt.elapsed % 60;
  const perfect = mt.errors === 0;
  document.getElementById('match-res-icon').textContent = perfect ? 'ğŸ†' : mt.errors <= 2 ? 'ğŸŒŸ' : 'ğŸ‘';
  document.getElementById('match-res-title').textContent = perfect ? '××•×©×œ×! ××¤×¡ ×˜×¢×•×™×•×ª!' : mt.errors <= 2 ? '×›××¢×˜ ××•×©×œ×!' : '×›×œ ×”×›×‘×•×“!';
  document.getElementById('match-res-score').textContent = score;
  document.getElementById('match-res-time').textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
  document.getElementById('match-res-errors').textContent = mt.errors;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentScreen = 'home';
let backPressedOnce = false;

function navigateTo(screen) {
  currentScreen = screen;
  if (screen === 'home') {
    history.replaceState({ screen: 'home' }, '');
  } else {
    history.pushState({ screen }, '');
  }
}

window.addEventListener('popstate', e => {
  const screen = e.state?.screen || 'home';

  if (screen === 'home') {
    // ×›×‘×¨ ×‘×“×£ ×”×‘×™×ª â€” ×œ×—×™×¦×” ×›×¤×•×œ×” ×œ×¡×’×™×¨×”
    if (backPressedOnce) {
      // ×¡×’×•×¨ ××ª ×”××¤×œ×™×§×¦×™×”
      history.back();
      return;
    }
    backPressedOnce = true;
    showToast('×œ×—×¥ ×©×•×‘ ×œ×¡×’×™×¨×”');
    setTimeout(() => { backPressedOnce = false; }, 2000);
    // ×“×—×•×£ state ××—×“×© ×›×“×™ ×©-popstate ×”×‘× ×™×¢×‘×•×“
    history.pushState({ screen: 'home' }, '');
  } else {
    goHome();
  }
});

function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = `
      position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
      background:rgba(26,26,46,0.85); color:white;
      padding:10px 22px; border-radius:99px;
      font-size:14px; font-weight:600;
      z-index:999; pointer-events:none;
      transition:opacity 0.3s;
    `;
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 1800);
}
function openNicknameModal() {
  const modal = document.getElementById('nicknameModal');
  modal.classList.remove('hidden');
  const input = document.getElementById('nicknameInput');
  input.value = state.nickname || '';
  setTimeout(() => input.focus(), 100);
}

function saveNickname() {
  const input = document.getElementById('nicknameInput');
  const name = input.value.trim();
  if (!name) { input.focus(); return; }
  state.nickname = name;
  saveState();
  document.getElementById('nicknameModal').classList.add('hidden');
  updateNicknameUI();
}

function updateNicknameUI() {
  const name = state.nickname;
  if (name) {
    document.getElementById('navUsername').textContent = name;
    document.getElementById('heroGreeting').innerHTML = `×”×™×™ ${name}! ğŸ‘‹<br>×‘×•× × ×œ××“ ×× ×’×œ×™×ª`;
  } else {
    document.getElementById('navUsername').textContent = 'ğŸ‘¤';
    document.getElementById('heroGreeting').innerHTML = `×©×œ×•×! ğŸ‘‹<br>×‘×•× × ×œ××“ ×× ×’×œ×™×ª`;
  }
}

// Enter key in nickname input
document.getElementById('nicknameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') saveNickname();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SERVICE WORKER (PWA)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadState();
</script>
</body>
</html>
